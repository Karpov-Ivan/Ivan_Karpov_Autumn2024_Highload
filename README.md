# Проектирование высоконагруженного сервиса интернет-магазина

---

<h3 id="Content">Содержание</h3>

#### 1. [Тема и целевая аудитория](#1)
#### 2. [Расчет нагрузки](#2)
#### 3. [Глобальная балансировка нагрузки](#3)
#### 4. [Локальная балансировка нагрузки](#4)
#### 5. [Логическая схема базы данных](#5)
#### 6. [Физическая схема базы данных](#6)
#### 7. [Алгоритмы](#7)
#### 8. [Технологии](#8)
#### 9. [Схема проекта](#9)
#### 10. [Обеспечение надёжности](#10)
#### 11. [Список серверов](#11)

#### [Источники](#sources)

---

<h2 id="1">1 Тема и целевая аудитория</h2>

## Тема
Маркетплейс Wildberries — российский международный интернет-магазин, предлагающий одежду, обувь, электронику, детские товары, товары для дома и другие категории товаров.

## MVP
1. Авторизация, регистрация по номеру телефона.
2. Поиск товаров по ключевым словам.
3. Главная страница персонализированных предложений.
4. Добавление товаров в корзину.
5. Редактирование количества и удаление товаров.
6. Оставление отзывов о приобретённых товарах.
7. Оформление заказа.
8. Статус заказа при доставке.
9. Добавление товаров продавцом на площадку с учётом фотографии.
10. Авторизация, регистрация для продавцов.
11. Открытие карточки товара.

## Продуктовые особенности
* Платежная система — удобная и безопасная система оплаты, которая поддерживает различные способы оплаты (банковские карты, электронные кошельки и другие), гарантируя комфорт и безопасность транзакций для пользователей.

## ЦА
Ниже представлена статистика исследования аудитории Wildberries.
Возраст целевой аудитории варьируется в диапазоне от 18 до 65+ лет. [[1]](https://www.similarweb.com/ru/website/wildberries.ru/#demographics)
Возрастная группа | Процентное соотношение
------------------| -------------
18-24 года        | 14,31% 
25-34 года        | 23,79% 
35-44 года        | 18,11% 
45-54 года        | 17,53% 
55-64 года        | 14,78% 
65+   года        | 11,48% 

Размер целевой аудитории: 58.7 млн. пользователей в месяц, 24.2 млн. пользователей в день на момент февраля 2024г. [[2]](https://oborot.ru/news/kolichestvo-posetitelej-marketplejsov-wildberries-i-ozon-v-mesyac-sravnyalos-kuda-eshhe-hodyat-pokupateli-i209527.html)

География пользователей:
Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 93.05%
Беларусь     | 2.06% 
Казахстан    | 1.74%
Армения      | 0.53% 
Другие       | 2.63% 

Гендерное распределение аудитории Wildberries [[3]](https://dzen.ru/a/ZkT8wKCKkBgtJMT-):
Пол          | Процентное соотношение
-------------| -------------
Мужской      | 30.00%
Женский      | 70.00% 

<h2 id="2">2 Расчёт нагрузки</h2>

Продуктовые метрики:
Метрика                                                                                         | Значение
------------------------------------------------------------------------------------------------| -----------------------
Месячная аудитория MAU                                                                          | 58.7 млн. пользователей
Дневная аудитория DAU                                                                           | 24.2 млн. пользователей
Количество регистраций в день [[4]](https://adindex.ru/news/researches/2023/02/28/310879.phtml) | 40 тыс. пользователей
Средняя длительность сессии   [[5]](https://dzen.ru/a/ZkT8wKCKkBgtJMT-)                         | 11 минут

### Хранилище данных для пользователя

Параметр                                                | Число
--------------------------------------------------------| -----------------
Поиск товаров по ключевым словам                        | 3 запросов/день
Добавление товаров в корзину                            | 4 товаров/день
Оформление заказа                                       | 1 заказов/день
Среднее количество товаров в заказе                     | 3 товаров
Оставление отзывов                                      | 2 отзывов/день
Средняя длина отзыва                                    | 60 символов UTF-8
Средний количество фотографий у отзыва                  | 3 шт.
Добавление товаров продавцом                            | 1 товаров/день
Средний размер товара без учета фотографии              | 6.3 кБ
Средний количество фотографий у товара                  | 7 шт.
Средний размер фотографии товара                        | 86 кБ
Главная страница персонализированных предложений        | 20 товаров/день
Добавление товаров продавцом                            | 4 товаров/день
Редактирование количества и удаление товаров из корзины | 2 товаров/день
Открытие карточки товара                                | 10 товаров/день
Статус заказа при доставке                              | 3 запроса/день

Объём данных на одного пользователя в день:
* Добавление товаров в корзину: 4 товара * 6.3 кБ = 25.2 кБ
* Оформление заказа: 3 товара * 6.3 кБ = 18.9 кБ
* Оставление отзывов: 2 отзыва * (0.06 кБ + 3 * 86 кБ) = 467.72 кБ
* Главная страница персонализированных предложений: 20 товаров * 6.3 кБ = 126 кБ.
* Добавление товаров продавцом: 4 товаров * (6.3 кБ + 7 * 86 кБ) = 4 товаров * 2461.2 кБ = 9844.8 кБ.
* Редактирование количества и удаление товаров из корзины: 2 товаров * 6.3 кБ = 12.6 кБ.
* Открытие карточки товара: 10 товаров * (6.3 кБ + 17 отзывов * 0.06 кБ) = 10 товаров * 7.32 кБ = 73.2 кБ.
* Статус заказа при доставке: 3 запроса * 7.6 кБ = 22.8 кБ
* Загрузка медиа: 48 * 86 кБ = 4128 кБ

Тогда общий объем товаров в день, добавляемых в корзину, оформленых в заказе, оставление отзывов, получение главной ленты на одного пользователя равен: 
4 * 6.3 (кБ) + 3 * 6.3 (кБ) + 2 * (0.06 (кБ) + 3 * 86 (кБ)) + 20 * 6.3 (кБ) + 4 * (6.3 (кБ) + 7 * 86 (кБ)) + 2 * 6.3 (кБ) + 10 * (6.3 (кБ) + 7 * 86 (кБ)) + 3 * 7.6 (кБ) + 48 * 86 (кБ) = 14719.22 кБ = 14.7 МБ

### Динамический рост

Так как за год заказывается около 618 млн. [[7]](https://www.cnews.ru/news/line/2023-06-08_wildberries_itogi_i_kvartala_2023) товаров, то можно вычислить, какой объем данных будет занят пользователями:
* Расчёт данных на товары (всего): 6.3 (кБ) * 618 млн. = 3.9 ТБ
* Расчёт данных только на фотографии товаров: 7 * 86 (кБ) * 618 млн. = 372.04 ТБ

### Сетевой трафик
При расчете сетевого трафика не будем учитывать запросы, связанные с регистрацией пользователей, так как они не создают ощутимую нагрузку на наш сервис.
Основная нагрузка приходится на оформление заказа, добавление в корзину и оставление отзывов.

### Предварительные расчеты:
### Трафик по видам активности на одного пользователя:
1. Поиск товаров:

* 3 запроса/день. Примерный объем одного запроса можно оценить в 10 кБ (запрос + ответ от сервера). Итого: 3 ∗ 10 кБ = 30 кБ

2. Добавление товаров в корзину:

* 4 товара/день. Объем данных на один товар — 6.3 кБ. Итого: 25.2 кБ

3. Оформление заказа:

* 1 заказ в день с 3 товарами. Итого: 18.9 кБ

4. Оставление отзывов:

* 2 отзыва/день, 467.72 кБ (как рассчитано ранее). Итого: 467.72 кБ

5. Главная страница персонализированных предложений:

* 20 товаров/день, 126 кБ (как рассчитано ранее). Итого: 126 кБ

6. Добавление товаров продавцом:

* 4 товаров/день, 9844.8 кБ (как рассчитано ранее). Итого: 9844.8 кБ

7. Редактирование количества и удаление товаров из корзины:

* 2 товаров/день, 12.6 кБ (как рассчитано ранее). Итого: 12.6 кБ

8. Открытие карточки товара:

* 10 товаров/день и 17 отзывов для каждого товара, 73.2 кБ (как рассчитано ранее). Итого: 73.2 кБ

9. Статус заказа при доставке:

* 3 запроса/день, 22.8 кБ (как рассчитано ранее). Итого: 22.8 кБ

10. Медиа в день со всех ручек:

* 48 медиа/день, 4128 кБ (как рассчитано ранее). Итого: 4128 кБ

10. Трафик на одного пользователя в день:

* 30 кБ + 25.2 кБ + 18.9 кБ + 467.72 кБ + 126 кБ + 9844.8 кБ + 12.6 кБ + 73.2 кБ + 22.8 кБ + 4128 кБ = 14719.22 кБ = 14.7 МБ

### Сетевой трафик по видам активности (дневная аудитория 24.2 млн. пользователей):

Пиковое значение активности пользователей(соответственно RPS тоже) приблизительно в 1.66 раза выше среднего значения. Возьмем коэффициент запаса равный 2

Тип                           | Отправка (дневная аудитория 24.2 млн) | Отправка Гб/сек | Пиковое значение | Значение с коэффициентом запаса 2 |
------------------------------| --------------------------------------| ----------------| -----------------|---------------------------------- |
Поиск товаров                 | 24.2 млн * 30 кБ = 726 ГБ             | 0.0084          | 0.0139           | 0.0168                            |
Добавление товаров в корзину  | 24.2 млн * 25.2 кБ = 609.84 ГБ        | 0.007           | 0.0117           | 0.014                             |
Оформление заказа             | 24.2 млн * 18.9 кБ = 457.38 ГБ        | 0.0053          | 0.0088           | 0.0106                            |
Оставление отзывов            | 24.2 млн * 467.72 кБ = 11 314 ГБ      | 0.131           | 0.217            | 0.262                             |
Главная страница              | 24.2 млн * 126 кБ = 3049.2 ГБ         | 0.035           | 0.0581           | 0.07                              |
Редактирование корзины        | 24.2 млн * 12.6 кБ = 304.92 ГБ        | 0.0035          | 0.00581          | 0.007                             |
Добавление товаров продавцом  | 24.2 млн * 9844.8 кБ = 236.28 ТБ      | 2.734           | 4.538            | 5.468                             |
Открытие карточки товара      | 24.2 млн * 73.2 кБ = 1771.44 ГБ       | 0.021           | 0.035            | 0.042                             |
Статус заказа при доставке    | 24.2 млн * 22.8 кБ = 551.76 ГБ        | 0.0063          | 0.011            | 0.0126                            |
Медиа                         | 24.2 млн * 4128 кБ = 99.8976 ТБ       | 1.156           | 1.92             | 2.312                             |
Итого                         | 354961.98 ГБ = 354.96 	ТБ             | 4.1071          | 6.8179           | 8.2142                            |

### RPS
 
* Поиск товаров: 24.2 млн * 3 / 86400 = 839 RPS
* Добавление товаров в корзину: 24.2 млн * 4 / 86400 = 1120 RPS
* Оформление заказов: 24.2 млн. * 1 / 86400 = 280 RPS
* Оставление отзывов: 24.2 млн. * 2 / 86400 = 560 RPS
* Добавление товаров продавцом: 24.2 млн. * 1 / 86400 = 280 RPS
* Главная страница персонализированных предложений: 24.2 млн * 20 / 86400 = 5600 RPS
* Редактирование количества и удаление товаров из корзины: 24.2 млн * 2 / 86400 = 560 RPS
* Добавление товаров продавцом: 24.2 млн * 4 / 86400 = 1120 RPS
* Открытие карточки товара: 24.2 млн * 10 / 86400 = 2800 RPS
* Статус заказа при доставке: 24.2 млн * 3 / 86400 = 841 RPS
* Загрузка медиа: 24.2 млн * 48 / 86400 = 13445 RPS

Действие                            | RPS   | Пиковое значение | Пиковое значение с коэффициентом запаса 2  |
------------------------------------| ------| -----------------| ------------------------------------------ |
Поиск товаров                       | 839   | 1393             | 2786                                       |
Добавление товаров в корзину        | 1120  | 1859             | 3718                                       |
Оформление заказов                  | 280   | 465              | 930                                        |
Оставление отзывов                  | 560   | 930              | 1860                                       |
Добавление товаров продавцом        | 280   | 465              | 930                                        |
Главная страница                    | 5600  | 9296             | 11200                                      |
Редактирование корзины              | 560   | 930              | 1120                                       |
Добавление товаров продавцом        | 1120  | 1860             | 2240                                       |
Открытие карточки товара            | 2800  | 4648             | 5600                                       |
Статус заказа при доставке          | 841   | 1396             | 1682                                       |
Загрузка медиа                      | 13445 | 22318            | 26890                                      |
**Итого**                           | 27445 | 45558            | 54890                                      | 

<h2 id="3">3 Глобальная балансировка нагрузки</h2>

### География пользователей

Целевая аудитория Wildberries распределена в основном по странам СНГ, с преобладанием в России. Вот как распределяются пользователи по регионам:

Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 93.05%
Беларусь     | 2.06% 
Казахстан    | 1.74%
Армения      | 0.53% 
Другие       | 2.63% 

Это определяет необходимость расположения датацентров (ДЦ) преимущественно в России и других странах СНГ для обеспечения низкой задержки и высокой производительности.

### Функциональное разбиение по доменам

Для оптимизации работы и распределения нагрузки по различным функциональным модулям можно применить функциональное разбиение по доменам. Это позволяет отдельным частям системы работать независимо друг от друга, улучшая масштабируемость и отказоустойчивость.

Примеры функциональных доменов:

* wildberries.ru — API-сервисы для мобильных приложений и веб-версии.
* cdn.wildberries.ru — доставка медиа-контента (фото товаров, видео, баннеры).
* wbxoofex.wildberries.ru — сервис оформления заказов и управления корзиной.
* search.wb.ru — отдельный домен для поиска товаров.
* seller.wildberries.ru — платформа для продавцов.

Такое разбиение позволяет улучшить управляемость трафика, распределять нагрузку на отдельные системы, а также внедрять более гибкие методы балансировки.

### Обоснование расположения ДЦ

На основе [географии пользователей](https://map.wb.ru/#2/53.05/127.13) можно обосновать расположение датацентров. Основная цель — снизить сетевые задержки и улучшить производительность для конечных пользователей.

Страна    | Локация ДЦ                | Обоснование
----------| --------------------------| ---------------------------------------------------------------------------------------------------
Россия    |	Москва                 	  | 93.05% пользователей из России, оптимизация для западной части страны
Россия    |	Санкт-Петербург	          | 93.05% пользователей из России, оптимизация для западной части страны
Россия    |	Новосибирск	              | Покрытие для пользователей Центральной России, Урала, Сибири, восточных регионов и Дальнего Востока
Беларусь  |	Минск	                    | Поддержка пользователей Беларуси (2.06%)
Казахстан |	Алматы	                   | Покрытие для пользователей Казахстана (1.74%)

Основное внимание уделяется России, так как большинство пользователей находится в этой стране. Однако наличие датацентров в соседних странах (Беларусь, Казахстан, Армения) помогает улучшить доступ к сервису и уменьшить задержки для пользователей этих регионов.

### Схема DNS-балансировки

Latency-Based DNS с использованием BGP-маршрутизации

Latency-Based DNS-балансировка направляет запросы пользователей на ближайший датацентр с наименьшей задержкой, оценивая это на основе метрик задержек в сети (latency) и BGP-маршрутов.

Алгоритм работы:
1. Пользовательский запрос: Пользователь отправляет запрос на домен.
2. Определение ближайшей BGP-подсети:
* DNS-сервер анализирует местоположение пользователя на основе IP-адреса. Это осуществляется за счёт баз данных, сопоставляющих IP с географической зоной и BGP-подсетью.
* DNS-сервер затем отправляет ICMP-запросы или использует протоколы мониторинга сети для замера latency (времени задержки) до ближайших датацентров в различных BGP-подсетях.
* По результатам измерений DNS выбирает BGP-подсеть с минимальной задержкой.
3. Маршрутизация на уровне BGP:
* После определения ближайшей BGP-подсети, запрос пользователя направляется в эту подсеть.
* Внутри выбранной BGP-подсети происходит более детальный анализ задержек между несколькими датацентрами. Например, если в выбранной подсети есть несколько датацентров, то на этом этапе измеряются задержки между пользователем и каждым из них.
4. Перенаправление на конкретный датацентр:
* После оценки задержек между всеми доступными датацентрами в выбранной BGP-подсети, запрос направляется в датацентр с наименьшей задержкой.
* Если ближайший датацентр перегружен или недоступен, механизм автоматически переключает запрос на следующий ближайший датацентр в этой же BGP-подсети с минимальной задержкой.

<h2 id="4">4 Локальная балансировка нагрузки</h2>

L3:
L3 будет использоваться в качестве первичной балансировки, чтобы распределить трафик по серверам внутри ЦОД. Балансировка будет по схеме Virtual Server via IP Tunneling

![image](https://raw.githubusercontent.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/refs/heads/main/images/311767474-de3f99a0-3714-429c-b93a-7ac53e610c17.png)


Для обеспечаения отказоустойчивости системы стоит использовать framework *keepalived* благодаря следующим преимуществам:
* Производительность
* Открытость
* Простота настройки

Будем использовать **Virtual Router Redundancy Protocol(VRRP)**. Соответственно, мы получаем возможность отслеживать состояние узлов системы, а при отказе одного из них перенаправить трафик на другой узел.

L7:
На отдельно взятом сервере будет проходить балансировка с помощью L7. На этом уровне для балансировщика нагрузки важна поддержка HTTP-заголовков. Будем использовать балансировщик NGINX благодаря следующим преимуществам:
* Лучшая производительность
* Поддержка различных протоколов(в т.ч. gRPC и HTTP)
* Открытость
* Гибкость настройки

Также для решения проблемы отказоустойчивости на этом уровне будет использоваться k8s с использованием:
* Liveness probe
* Readiness probe

Для шифрования будем пользоваться услугами центра [Let's encrypt](https://letsencrypt.org)
Для оптимизации установки соединения будет пользоваться Session cache

<h2 id="5">5 Логическая схема базы данных</h2>

## Схема базы данных
[Ссылка на логическую схему БД](https://dbdiagram.io/d/6702ea1cfb079c7ebd82a4c2)

![Highload Ivan Karpov DB](https://github.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/blob/main/images/DB_WB_6.png)

**PRODUCT -> FILE_ID**
```bash
{
  "main_image": "https://s3.amazonaws.com/mybucket/main_image.jpg",
  "gallery": [
    "https://s3.amazonaws.com/mybucket/image1.jpg",
    "https://s3.amazonaws.com/mybucket/image2.jpg"
  ]
}
``` 
---
**PRODUCT -> ATTRIBUTES**
```bash
{
  "sizes": ["S", "M", "L", "XL"],
  "color": "red",
  "weight": "1.2 kg",
  "material": "cotton",
  "dimensions": {
    "width": "30 cm",
    "height": "50 cm",
    "depth": "10 cm"
  }
}
``` 
---
**PRODUCT -> CATEGORY_ID**
```bash
[
  'uuid1',
  'uuid2',
  'uuid3'
]
``` 
---
**COMMENT -> FILE_ID**
```bash
{
  "main_image": "https://s3.amazonaws.com/mybucket/main_image.jpg",
  "gallery": [
    "https://s3.amazonaws.com/mybucket/image1.jpg",
    "https://s3.amazonaws.com/mybucket/image2.jpg"
  ]
}
``` 
---
**ORDER_ITEM -> STATUS**
```bash
{
  "current_status": "delivered", // Текущий статус заказа
  "history": [
    {
      "status": "pending", // Статус: ожидается
      "updated_at": "2024-10-01T12:00:00Z" // Дата изменения статуса
    },
    {
      "status": "shipped", // Статус: отправлен
      "updated_at": "2024-10-02T08:30:00Z"
    },
    {
      "status": "delivered", // Статус: доставлен
      "updated_at": "2024-10-03T14:45:00Z"
    }
  ]
}
``` 
---
**ORDER_ITEM -> ITEMS**
```bash
[
  {
    "product_id": "uuid1",
    "quantity": 2,
    "price": 1000
  },
  {
    "product_id": "uuid2",
    "quantity": 1,
    "price": 500
  }
]
``` 
---
**SHOPPING_CART_ITEM -> ITEMS**
```bash
[
  {
    "product_id": "uuid1",
    "quantity": 2,
    "price": 1000,
    "added_at": "2024-10-23T10:00:00Z"
  },
  {
    "product_id": "uuid2",
    "quantity": 1,
    "price": 500,
    "added_at": "2024-10-23T11:00:00Z"
  }
]
``` 
---
**MODERATION -> STATUS**
```bash
[
  'pending',
  'approved',
  'rejected'
]
``` 
---
**PRODUCT_EVENT -> EVENT_TYPE**
```bash
[
  'view',
  'click',
  'purchase'
]
``` 
---
**COMPANY_EVENT -> EVENT_TYPE**
```bash
[
   'product_added',
   'moderation_completed'
]
``` 
---
**COMMENT_EVENT -> EVENT_TYPE**
```bash
[
   'view',
   'rating_updated'
]
``` 
---
**PRODUCT_RATING_EVENT -> EVENT_TYPE**
```bash
[
   'new_rating',
   'comment_added'
]
``` 
---
**PROFILE_ACTIVITY -> ACTION_PRODUCT**
```bash
[
  {
    "product_id": "uuid1",
    "action": "view", // "click", "add_to_cart", "purchase"
    "timestamp": "2024-10-23T10:00:00Z"
  },
  {
    "product_id": "uuid2",
    "action": "click", // "view", "add_to_cart", "purchase",
    "timestamp": "2024-10-23T10:00:00Z"
  }
]
``` 
---
**PROFILE_FEATURES -> FAVORITE_CATEGORIES**
```bash
{
    'category1': 0.8,
    'category2': 0.2
}
``` 
---

Тип       | Размер в байтах
----------| --------------------------------------------------
uuid      | 16
int       | 4
numeric   | 8
timestamp | 8
boolean   | 1
text      | Динамический, зависит от длины (1 символ ≈ 1 байт)

<h2 id="6">6 Физическая схема базы данных</h2>

Таблица | Технология | Обоснование
--------| -----------| -----------------------------------------------------------------------------------------------------------------------------------------------------
Session | Redis      | Redis подходит для хранения сессий благодаря in-memory хранению данных и высокой производительности при работе с временными данными (TTL). Также есть поддержка организации кластера Redis cluster и неблокирующей репликации master-slave.
Address, Category, Moderation, Country, City, Street, House, Apartment | PostgreSQL | Реляционные таблицы с отношениями и строгой структурой данных. PostgreSQL предоставляет мощные возможности для работы с транзакциями и обеспечит целостность данных (например, связи между профилями, товарами, заказами и прочим).
Profile, Product, Company, Comment, Order_Info, File, Shopping_Cart_Item | MongoDB | MongoDB идеально подходит для хранения неструктурированных данных. Она обеспечивает гибкость в организации данных, позволяет эффективно работать с большими объемами информации и масштабироваться при необходимости. 
Product_Stats, Product_Rating, Comment_Stats, Product_Event_, Company_Event_, Comment_Event_, Product_Rating_Event_ | ClickHouse | ClickHouse - колоночная база данных, предназначенная для быстрого чтения и анализа больших объемов данных. ClickHouse отличается высокой производительностью при чтении, особенно при агрегации данных. ClickHouse оптимизирован для быстрой вставки больших объемов данных. Он использует механизм "append-only", где новые данные добавляются в конец таблицы, что ускоряет процесс. 
Product_, Company_ | Elasticsearch | Для полнотекстового поиска по товарам используем Elasticsearch. Он поддерживает высокоэффективный поиск по ключевым словам и легко интегрируется с системой благодаря API.
File_S3 | AWS S3 | Хранение больших файлов (фотографий и других медиа) будет производиться в облачном хранилище. AWS S3 предоставляет высокую доступность, репликацию данных и простое управление большими объемами файлов.
Product_Event, Company_Event, Comment_Event, Product_Rating_Event | Kafka | Kafka используется для обработки и передачи событий в режиме реального времени. Эти таблицы представляют собой временные хранилища событий из Kafka, таких как действия пользователей (просмотры, клики, рейтинги, комментарии). Kafka обеспечивает надежную доставку сообщений и масштабирование, что делает его подходящим для обработки высоконагруженных систем, где необходимо передавать события между различными компонентами системы.
Profile_Activity, Profile_Features, Product_Features | Yandex DataLens + YT | Yandex DataLens и YT идеально подходят для работы с распределенными данными. YT поддерживает map-reduce и сложные ETL-процессы, что упрощает подготовку данных для аналитики и рекомендаций.

### Индексы:
Индексация критически важна для оптимизации работы с базой данных. Добавим индексы на часто используемые поля:

Таблица              |	Поле	          | Цель индекса
-------------------- | -------------- | ----------------------------------------------
Session	             | token          |	Идентификация сессии.
Session              | profile_id     |	Быстрый доступ к профилю пользователя.
Session              | last_access_at	| Поиск или удаление неактивных сессий.             
Profile              |	login          |	Ускорение поиска по логину.
Profile              | phone          |	Регистрация и авторизация по номеру телефона.
Profile              | statusDeleted  |	Фильтрация активных и удалённых пользователей.
Address              |	profile_id     |	Получение адресов пользователя.
Address              | country_id     |	Поиск по стране.
Address              | city_id        |	Поиск по городу.
Address              | street_id      |	Поиск по улице.
Country              |	name           |	Поиск по названию страны.
City                 |	country_id     |	Поиск городов в стране.
City                 | name           |	Поиск по названию города.
Street               |	city_id        |	Поиск улиц в городе.
Street               | name           |	Поиск по названию улицы.
House                |	street_id      |	Поиск домов на улице.
Apartment            |	house_id       |	Поиск квартир в доме.
Product              |	id             |	Поиск по идентификатору.
Product              | name           |	Поиск по названию.
Product              | category_id    |	Фильтрация по категориям.
Product              | company_id     | Поиск товаров продавца.
Product              | price          |	Сортировка по цене.
Product_	            | name           |	Полнотекстовый поиск по названию.
Product_             | description    |	Полнотекстовый поиск по описанию.
Product_Rating       |	product_id     |	Доступ к рейтингу товара.
Product_Stats        |	product_id     |	Отслеживание статистики товара.
Category             |	name           |	Поиск категорий по названию.
Category             | parent         |	Поиск подкатегорий.
File                 |	link_file      |	Быстрый доступ по ссылке.
Comment              |	product_id     |	Получение комментариев к продукту.
Comment              | profile_id     |	Отслеживание комментариев пользователя.
Comment_Stats        |	comment_id     |	Работа со статистикой комментариев.
Shopping_Cart_Item   |	profile_id	    | Поиск товаров в корзине пользователя.
Shopping_Cart_Item   | product_id     |	Доступ к товарам в корзине.
Order_Info           |	profile_id     |	Поиск заказов пользователя.
Order_Info           | address_id     |	Поиск заказов по адресу доставки.
Company              |	inn            |	Поиск компаний по ИНН.
Moderation           |	product_id     |	Ускорение модерации товара.
Company_             |	name           |	Полнотекстовый поиск магазина.
Company_             | inn            |	Поиск по ИНН.
Company_             | profile_id     |	Полнотекстовый поиск по профилю.
Product_Event        |	product_id	    | Доступ к событиям товара.
Product_Event        | event_type     |	Фильтрация событий по типу.
Product_Event        | event_time     |	Сортировка событий по времени.
Company_Event        |	company_id     |	Доступ к событиям компании.
Company_Event        | event_type     |	Фильтрация событий компании.
Company_Event        | event_time     |	Сортировка событий компании.
Comment_Event        |	comment_id     |	Доступ к событиям комментариев.
Comment_Event        | event_type     |	Фильтрация событий комментариев.
Comment_Event        | event_time     |	Сортировка событий комментариев.
Product_Rating_Event |	product_id     |	Доступ к событиям рейтинга.
Product_Rating_Event | event_type     |	Фильтрация событий рейтинга.
Product_Rating_Event | event_time	    | Сортировка событий по времени.
Profile_Activity     | profile_id     | Быстрый доступ к профилю пользователя.
Profile_Features     | profile_id     | Быстрый доступ к профилю пользователя.
Product_Features     | product_id     | Отслеживание особенностей товара.

### Шардирование и резервирование:
Шардирование позволит распределить нагрузку на базу данных, избегая узких мест и повышения отказоустойчивости:

Система       |	Таблица / Данные     |	Шардирование                                     |	Резервирование
----------    | -------------------- | ------------------------------------------------ | ---------------------------------------------------------------
MongoDB       |	Product              |	По product_id                                    |	Мастер-репликация: чтение из реплик, запись в основной инстанс.
ClickHouse    | Product_Stats        |	По product_id	                                   | Мастер-репликация: чтение из реплик, запись в основной инстанс.
ClickHouse    | Product_Rating       |	По product_id	                                   |	Мастер-репликация: чтение из реплик, запись в основной инстанс.
MongoDB       | Comment              |	По product_id	                                   |	Мастер-репликация: чтение из реплик, запись в основной инстанс.
MongoDB       | Order_Info           |	По profile_id	                                   |	Мастер-репликация: чтение из реплик, запись в основной инстанс.
MongoDB       |	Shopping_Cart_Item   |	По profile_id                                    |	Встроенная репликация для отказоустойчивости.
Redis	        | Session              |	Нет шардирования                                 |	Master-slave репликация для обеспечения отказоустойчивости.
Elasticsearch |	Индексируемые данные |	Встроенное шардирование по ключевым полям поиска |	-

### Схема резервного копирования:
1) PostgreSQL:
* Использование pg_dump для регулярного создания бэкапов базы данных. Бэкапы сохраняются на удаленный сервер или в облачное хранилище (например, S3).
2) Redis:
* Redis поддерживает сохранение снимков данных через RDB (Redis Database Backup) и AOF (Append Only File). RDB можно использовать для периодических полных бэкапов, а AOF для сохранения журнала операций.
3) Elasticsearch:
* Использование встроенной системы снапшотов Elastic для регулярных бэкапов данных в удаленное хранилище (например, S3).
4) AWS S3:
* Файлы на S3 защищены встроенной системой версионирования и высокой доступностью. Рекомендуется использовать Glacier для долгосрочного хранения архивных данных.
5) ClickHouse:
* ClickHouse поддерживает резервное копирование через встроенные механизмы создания снапшотов и репликацию. Снимки (snapshots) можно сохранять локально или в удаленное хранилище (например, S3).
6) Kafka:
* Kafka поддерживает репликацию журналов сообщений между брокерами, что обеспечивает высокую доступность и отказоустойчивость. Для создания резервных копий можно использовать специальные утилиты, такие как MirrorMaker, который дублирует данные в другом кластере Kafka, или сохранять данные на внешние носители.
7) MongoDB:
* Для резервного копирования в MongoDB используется инструмент mongodump, который позволяет создать бэкап всей базы данных или её отдельных коллекций. Эти бэкапы можно сохранить локально или в облачное хранилище, например, AWS S3. MongoDB также поддерживает оптимизированные снапшоты в случае использования шардированного кластера.
8) Yandex DataLens + YT:
* Поддержка встроенных снапшотов и периодического резервного копирования данных в распределенные хранилища. Бэкапы метаданных (например, отчетов и дашбордов) сохраняются в виде JSON/SQL-файлов в облаке.

### Клиентские библиотеки:
1) PostgreSQL:
Для работы с PostgreSQL в Go часто используют следующие библиотеки:
- [pgx](https://github.com/jackc/pgx): Один из самых популярных и мощных драйверов для работы с PostgreSQL. Поддерживает транзакции, мультиплексирование соединений, и работу с подготовленными запросами.
- [GORM](https://gorm.io/): ORM для Go, который поддерживает PostgreSQL. Позволяет работать с базой данных на высоком уровне, используя объекты и запросы на уровне сущностей.
2) Redis:
Для интеграции с Redis в Go можно использовать следующие библиотеки:
- [go-redis](https://github.com/go-redis/redis): Самая популярная библиотека для работы с Redis в Go. Поддерживает основные команды Redis, работу с кластерами и транзакциями.
3) Elasticsearch:
Для работы с Elasticsearch в Go можно использовать клиентскую библиотеку, разработанную самими разработчиками Elasticsearch:
- [Elastic Go Client](https://github.com/elastic/go-elasticsearch): Официальный клиент для работы с Elasticsearch, поддерживает все основные функции Elasticsearch.
4) AWS S3:
Для работы с AWS S3 можно использовать официальный SDK от AWS для Go:
- [AWS SDK for Go](https://github.com/aws/aws-sdk-go): Поддерживает работу с S3 и другими сервисами AWS.
5) ClickHouse:
Для работы с ClickHouse в Go доступны следующие библиотеки:
- [ClickHouse Go](https://github.com/ClickHouse/clickhouse-go): Официальный клиент для работы с ClickHouse. Поддерживает все основные функции, включая создание запросов, чтение и запись данных.
6) Kafka:
Для интеграции с Apache Kafka в Go можно использовать следующие библиотеки:
- [Sarama](https://github.com/Shopify/sarama): Одна из самых популярных библиотек для работы с Kafka в Go. Поддерживает как продюсеров (producers), так и потребителей (consumers), включая работу с разделами (partitions) и балансировку нагрузки.
7) MongoDB: 
Для работы с MongoDB в Go можно использовать следующую библиотеку:
-  [MongoDB Go Driver](https://github.com/mongodb/mongo-go-driver): Официальный клиент для работы с MongoDB. Поддерживает все основные функции MongoDB, включая подключение к кластеру, работу с коллекциями, выполнение запросов, индексацию и агрегацию.
8) Yandex DataLens + YT:
- [YT Go SDK](https://github.com/yandex-cloud/go-sdk): Официальный клиент для работы с YT и другими сервисами Yandex Cloud. Поддерживает взаимодействие с таблицами, выполнение запросов и обработку больших объемов данных.
- DataLens API: Для управления и автоматизации взаимодействия с DataLens через REST API. Используется для создания, обновления и управления дашбордами и отчетами.

<h2 id="7">7 Алгоритмы</h2>

## Поиск товаров

Поиск — один из основных источников дохода маркетплейсов. Основаня задача поиска строиться следующим образом. По некому запросу нужно выбрать множество товаров и упорядочить его таким образом, чтобы результирующий отранжированный список максимизировал показатель удовлетворенности пользователей.

### Этапы поиска:

### 1. Retrieval:
**Описание:** На этом этапе задача состоит в том, чтобы найти множество товаров, которые потенциально могут быть релевантны запросу пользователя. Для этого используется механизм поиска, основанный на индексации данных, например, с использованием ElasticSearch (ES).

**Подробный процесс:**
1) Каждый товар из таблицы `Product_` индексируется по важным полям, таким как название товара и его описание. *Индексация* — это процесс создания структуры данных, которая позволяет быстро находить документы (товары), соответствующие поисковому запросу.
2) Пользовательский запрос преобразуется в JSON-объект, который отправляется в ElasticSearch. Запрос может содержать несколько параметров, например, ключевые слова.
3) Поиск по ключевым словам:
- ElasticSearch ищет совпадения как по точным словам, так и по их частям (например, по частям слов в названии и описании товаров). Это позволяет найти товары, в которых встречаются как точные, так и неточные совпадения с запросом.
  - В основе частичного совпадения в ElasticSearch лежит алгоритм анализатора текста, который использует технику токенизации и n-граммы для обработки текста.
  - Токенизация — это процесс разбиения текста на отдельные компоненты (токены), такие как слова. Эти токены индексируются, и поиск может производиться как по полным токенам (словам), так и по их частям.
  - Пример: Если пользователь вводит запрос "футболка", ElasticSearch может искать товары с токенами "футбол", "болка", "форма". Это достигается с помощью индексов n-грамм — последовательностей из нескольких символов, которые помогают находить частичные совпадения.
- ElasticSearch использует механизм векторного поиска (Approximate Nearest Neighbor - ANN), что позволяет находить товары, близкие к запросу по смыслу, а не только по точным совпадениям ключевых слов. Это эффективно для поиска товаров с неточными совпадениями или синонимами. Векторный поиск в ElasticSearch основан на методах поиска ближайших соседей в многомерных пространствах. Алгоритм Approximate Nearest Neighbor (ANN) помогает ускорить процесс поиска, особенно в высокоразмерных векторных пространствах.
**Алгоритм ANN:**
  - Запрос и документы (товары) представляются в виде векторов в многомерном пространстве.
  - Для каждого товара (документа) создается векторное представление на основе его текста (название, описание) с использованием техник, таких как `Word2Vec`, которые кодируют семантическую информацию.
  - Задача поиска заключается в нахождении ближайших соседей (векторов товаров), которые находятся на минимальном расстоянии от вектора запроса. Для нахождения ближайших товаров (соседей) используется `косинусное расстояние` или `евклидово расстояние`. Чем выше значение косинусной близости, тем релевантнее товар.
  - Пример: Если запрос "красная футболка", то ANN алгоритм находит товары, чьи векторы находятся максимально близко к вектору запроса, даже если в названии или описании товара нет точного совпадения слов, но есть схожие по смыслу термины.
4) В результате Retrieval возвращается большое множество товаров, которые хотя бы частично соответствуют запросу пользователя, не учитывая их ранжирование на этом этапе.

### 2. Ranking:
**Описание:** Теперь, когда мы получили большое множество товаров на этапе Retrieval, необходимо их упорядочить по релевантности. Здесь ElasticSearch использует алгоритм BM25, который оценивает, насколько релевантен каждый товар запросу пользователя.

**Подробный процесс:**
1) Okapi BM25: Это алгоритм ранжирования, который использует следующие параметры для оценки релевантности:
  - TF (Term Frequency): Количество раз, которое ключевое слово из запроса встречается в документе (товаре). Чем больше совпадений, тем выше оценка.
  - IDF (Inverse Document Frequency): Вес каждого ключевого слова, учитывающий, насколько редкое или частое это слово в базе данных товаров. Редкие слова имеют больший вес, чем часто встречающиеся.
  - Длина документа: Более длинные тексты (например, длинные описания товаров) могут получить меньше веса, так как вероятность случайного совпадения выше.
2) В результате, товары сортируются в зависимости от их релевантности запросу с учётом всех вышеперечисленных параметров, и формируется список товаров для дальнейшей обработки.

### 3. Re-ranking:
**Описание:** После этапа ранжирования с помощью BM25, когда отобраны несколько тысяч наиболее релевантных товаров, проводится дополнительное реранжирование с использованием методов машинного обучения. На этом этапе, помимо текстовой релевантности, в расчет берутся другие факторы, которые могут влиять на пользовательский опыт.

**Подробный процесс:**
1) **Логистическая регрессия** — это популярная модель машинного обучения, используемая для бинарной классификации, но в задаче реранжирования она применяется для оценки вероятности того, что конкретный товар удовлетворяет запрос пользователя с учетом различных факторов.  
Эта модель позволяет учитывать несколько факторов одновременно:
   - Как близки название и описание товара к поисковому запросу пользователя.
   - Данные о кликах, покупках и взаимодействиях пользователей с похожими товарами. Эти данные берутся из таблицы `Product_Stats`.

Для реранжирования товаров логистическая регрессия решает задачу предсказания вероятности `P(Y = 1 | X)`, где:
   - `Y = 1` указывает на то, что товар подходит запросу пользователя.
   - `X` — это вектор признаков для каждого товара (включает текстовую релевантность, клики, покупки, рейтинги и т.д.).   
Цель логистической регрессии — найти набор весов β, который максимизирует вероятность того, что товары с высокими значениями предсказания действительно подходят запросу пользователя.

Логистическая регрессия рассчитывает вероятность как функцию от взвешенной суммы признаков. Основное уравнение модели:
```
P(Y = 1 | X) = 1/(1 + e^-(β_0 + β_1 * X_1 + β_2 * X_2 + ... + β_n * X_n))
```
где:
- `P(Y = 1 | X)` — вероятность того, что товар интересен пользователю,
- `β_0` — смещение (или интерцепт),
- `β_1, β_2, ..., β_n` — веса, которые логистическая регрессия присваивает каждому признаку `X_1, X_2, ..., X_n`.

Значение каждого признака умножается на соответствующий вес, и все произведения суммируются. Эта сумма затем проходит через сигмоидную функцию `σ(x) = 1/(1 + e^-x)`, которая преобразует результат в значение от 0 до 1 — интерпретируемое как вероятность.

2) Модель рассчитывает итоговый скор (это значение вероятности от 0 до 1, отражающее, насколько вероятно, что товар заинтересует пользователя) для каждого товара, и на этом этапе товары сортируются по этому скору, учитывая как текстовую релевантность, так и исторические данные и предпочтения пользователей. Чем выше скор, тем выше товар будет отображен в списке.

## Главная страница персонализированных предложений
Главная страница Wildberries отображает персонализированные предложения на основе данных, собранных о пользователе, и взаимодействий с платформой.

Алгоритм персонализации:
1) Сбор данных — информация о действиях пользователя (просмотры, клики, добавления в корзину) хранится в таблицах Shopping_Cart_Item, Product_Stats, Product_Rating.
2) Анализ предпочтений — используется машинное обучение для предсказания товаров, которые могут быть интересны пользователю на основе данных из таблиц Shopping_Cart_Item, Order_Info и Profile.
Градиентный бустинг — это мощный метод машинного обучения, который строит ансамбль решающих деревьев, где каждая новая модель направлена на минимизацию ошибок предыдущих моделей.
**Подробный процесс:**
- **Инициализация модели**:
Алгоритм начинает с базовой модели, которая делает простое предсказание для всех данных. Чаще всего в качестве первой модели используется среднее значение целевой переменной (например, средний интерес пользователей к товарам).
- **Обучение решающих деревьев**:
На каждом шаге строится новое решающее дерево, которое обучается на остатках (ошибках) предыдущей модели. Остатки вычисляются как разница между истинными значениями и предсказаниями текущей модели.
- **Суммирование предсказаний**:
После обучения нового дерева его предсказания добавляются к итоговому предсказанию. Итоговое предсказание представляется как сумма предсказаний всех деревьев в ансамбле:
```
𝐹(𝑥)=𝐹0(𝑥)+M∑𝑚=1(𝛾_𝑚*ℎ_𝑚(𝑥))
```
где:
- `𝐹(𝑥)` — итоговое предсказание,
- `𝐹0(𝑥)` — начальное предсказание (например, среднее),
- `𝛾_𝑚` — вес нового дерева,
- `ℎ_𝑚(𝑥)` — предсказание 𝑚-го дерева.

Градиентный бустинг позволяет учитывать множество факторов одновременно, включая:
- Текстовую близость товаров к интересам пользователя.
- Данные о кликах, покупках и взаимодействиях пользователей с похожими товарами.
3) Ранжирование товаров — алгоритм учитывает как текстовую близость товаров к интересам пользователя, так и бизнес-логику (например, товары, участвующие в акциях).

## Модерация
Для обеспечения качества представляемых товаров и контента на платформе Wildberries используется двухэтапная система модерации.
### Автоматическая модерация
Товары проходят автоматическую проверку на соответствие правилам площадки с помощью анализа данных из таблиц Product и Moderation. На этом этапе используется модель машинного обучения для фильтрации контента, который может нарушать правила (например, некорректные изображения или описание).

Мы можем использовать наивный байесовский классификатор как простую и эффективную модель для этой задачи.
**Подробный процесс:**
1) **Сбор данных**:
В первую очередь, необходимо собрать данные о запрещённом контенте, включая тексты и изображения, которые нарушают правила площадки.
Собранные данные должны быть размечены: указываем, какой контент является запрещённым (положительный класс) и какой — разрешённым (отрицательный класс).
2) **Предобработка данных**:
- Тексты описаний проходят через предобработку, включая удаление стоп-слов, токенизацию и стемминг/лемматизацию. Это помогает подготовить текст для анализа.
- Для изображений применяются методы обработки, такие как изменение размера, нормализация и использование признаков, таких как цветовые гистограммы или использование предобученных моделей для извлечения векторных представлений изображений.
3) **Обучение модели**:
Эта модель использует вероятностный подход для классификации контента. На этапе обучения она анализирует, как часто определённые слова (или пиксели, если речь идет об изображениях) встречаются в разных классах (разрешённом и запрещённом контенте).

Модель строит вероятностную модель, используя формулу Байеса:
```
P(Class∣Features)= (P(Features∣Class)⋅P(Class)) / P(Features)
```
​где:
- `P(Class∣Features)` — вероятность принадлежности к классу при заданных признаках.
- `P(Features∣Class)` — вероятность наблюдать эти признаки при условии, что они принадлежат определённому классу.
- `P(Class)` — вероятность данного класса.
- `P(Features)` — вероятность наблюдать данные признаки.

4) **Автоматическая модерация**:
При загрузке нового товара, модель анализирует текстовые и визуальные признаки, чтобы определить, принадлежит ли контент к запрещённому классу. Если модель определяет, что контент нарушает правила, товар автоматически блокируется или отправляется на ручную модерацию для дополнительной проверки.

### Ручная модерация
Сотрудники площадки могут просматривать товары, отмеченные системой, или отклоненные пользователями. Таблица Moderation хранит информацию о статусах модерации, причинах отклонения и времени проверки.

<h2 id="8">8 Технологии</h2>

| Технология        | Область применения                       | Обоснование                                                                                                    |
| ----------------- | ---------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| Typescript        | Фронтенд                                 | Преобразует JavaScript в статически типизированный язык, что позволяет отлавливать ошибки еще на этапе разработки, улучшает читаемость и поддержку кода, способствует снижению количества багов и повышению безопасности приложений. |
| React             | Фронтенд                                 | Библиотека для построения пользовательских интерфейсов с высокими требованиями к скорости и отзывчивости. Подходит для SPA, поддерживает компоненты, переиспользование кода и эффективный рендеринг благодаря Virtual DOM, что повышает производительность и гибкость в разработке. |
| Kotlin            | Мобильное приложение Android             | Язык, используемый для разработки Android-приложений, предлагает лаконичную и безопасную синтаксис для создания приложений, поддерживает корутины для асинхронных операций, что делает его удобным для построения быстрореагирующих интерфейсов. |
| Swift             | Мобильное приложение iOS                 | Основной язык для разработки iOS-приложений. Обеспечивает высокую производительность, интегрируется с iOS SDK и является безопасным, современным и оптимизированным для создания приложений с высоким уровнем UX. |
| Golang            | Бэкенд                                   | Высокопроизводительный язык программирования, который подходит для разработки масштабируемых сервисов. Поддерживает параллельное выполнение задач, что делает его идеальным для серверных приложений, работающих под высокой нагрузкой. |
| Prometheus        | Сбор метрик                              | Система мониторинга и оповещений, оптимизированная для сбора и хранения временных рядов данных. Позволяет получать и хранить информацию о состоянии системы и сервисов, настроена на отслеживание показателей производительности и состояния в режиме реального времени. |
| Grafana           | Визуализация метрик, мониторинг          | Визуализирует метрики из различных источников (например, Prometheus) в виде графиков и дашбордов, что помогает инженерам следить за состоянием системы, выявлять проблемы и отслеживать показатели производительности. |
| Docker            | Среда выполнения контейнеров             | Инструмент для упаковки приложений и их зависимостей в контейнеры, что упрощает переносимость, изоляцию и масштабирование приложений. Это также облегчает развертывание в любых средах, обеспечивая стабильную работу вне зависимости от окружения. |
| Kubernetes        | Оркестрация и развертывание контейнеров  | Система автоматизации развертывания, управления и масштабирования контейнеризированных приложений. Позволяет управлять кластером контейнеров и обеспечивает автоматическое распределение нагрузки, самоисцеление сервисов и масштабирование. |
| Nginx             | Балансировщик нагрузки уровня L7         | Высокопроизводительный веб-сервер и обратный прокси-сервер, часто используется как балансировщик нагрузки. Позволяет распределять запросы между серверами, повышая доступность и устойчивость системы, снижая нагрузку на backend. |
| Redis             | Хранилище сессий, кэширование            | База данных в оперативной памяти, которая обеспечивает быстрый доступ к данным. Подходит для кэширования и хранения временных данных, таких как сессии пользователей, за счет поддержки TTL (time-to-live) и механизма in-memory, что улучшает производительность. |
| PostgreSQL        | Основная база данных                     | Надежная реляционная СУБД с поддержкой транзакций ACID, которая обеспечивает целостность данных, поддерживает сложные запросы и связи между таблицами. Подходит для хранения и обработки основной информации о пользователях, продуктах и заказах. |
| ElasticSearch     | Поисковый движок                         | Высокопроизводительный движок для полнотекстового поиска, позволяющий быстро и эффективно находить данные по ключевым словам и фильтрам. Это улучшает скорость поиска и облегчает работу с большим объемом данных. |
| Apache Kafka      | Брокер сообщений                         | Система для обработки потоков данных в режиме реального времени. Поддерживает устойчивую доставку сообщений, позволяет организовать асинхронное взаимодействие между микросервисами, что особенно важно для событий, поступающих с высокой частотой. |
| Clickhouse        | OLAP-хранилище	                          | Колонковая СУБД, которая предназначена для аналитики и работы с большими объемами данных. Обеспечивает быструю агрегацию и обработку данных, что делает её идеальной для аналитики и генерации отчетов. |
| AWS S3            | Хранилище файлов и резервное копирование | Облачное хранилище для долговременного хранения и резервного копирования данных. Предлагает высокий уровень доступности и надежности, автоматическую репликацию и интеграцию с другими сервисами AWS. |
| WebP              | Формат изображений                       | Формат изображений, который сжимает файлы без потери качества, позволяя сократить их размер и повысить производительность при загрузке на веб-сайтах и мобильных приложениях. |
| Vault             | Хранилище секретов                       | Средство для безопасного хранения и управления доступом к конфиденциальной информации, такой как пароли и API-ключи, предотвращает несанкционированный доступ и улучшает безопасность системы. |
| Linkerd           | Сервисная mesh-сеть                      | Linkerd обеспечивает надёжное сетевое взаимодействие, выполняя автоматическое шифрование трафика между сервисами (MTLS) для защиты от атак, перехвата данных и повышения конфиденциальности. |
| InfluxDB          | Хранилище логов и временных рядов        | СУБД для временных рядов, используемая для хранения и анализа метрик и логов. Оптимизирована для обработки данных в реальном времени, позволяет анализировать тенденции и обнаруживать аномалии. |
| CDN Cloudflare    | Доставка статического контента           | Сеть доставки контента улучшает производительность сайта, кэшируя и доставляя статические ресурсы пользователям через узлы, расположенные по всему миру. Это сокращает время загрузки и улучшает пользовательский опыт, уменьшая нагрузку на основные серверы. |
| Keepalived        | Балансировка нагрузки уровня L3          |	Keepalived обеспечивает отказоустойчивость и позволяет распределять трафик по серверам внутри ЦОД. Поддерживает Virtual Router Redundancy Protocol (VRRP), что позволяет перенаправлять трафик при отказе узлов, повышая отказоустойчивость системы. |
| GitLab            | Система контроля версий, CI/CD           |	Популярная платформа для автоматизации CI/CD процессов и управления версиями. |
| Python            |	Машинное обучение                        |	Основной язык программирования для Data Science и машинного обучения, поддерживает богатую экосистему библиотек и инструментов для анализа данных и построения моделей. |
| Numpy, Scipy      |	Математические вычисления                |	Используются для линейной алгебры, вычисления расстояний и обработки массивов данных, что важно для векторного поиска и обработки текстовых запросов. |
| Word2Vec          |	Представление текста в виде векторов     |	Генерирует плотные векторные представления текстов, обеспечивая семантический поиск и улучшение релевантности результатов. Подходят для преобразования текстов запросов и описаний товаров в векторы. |
| scikit-learn      |	Модели классификации и ранжирования      |	Библиотека для работы с классическими алгоритмами машинного обучения, такими как логистическая регрессия и наивный байесовский классификатор. Позволяет быстро настраивать и тренировать модели для реранжирования и модерации контента. |
| BM25              |	Ранжирование в поиске                    |	Алгоритм ранжирования, подходящий для полнотекстового поиска. Учитывает частоту терминов и длину документа, что важно для повышения точности поиска. |
| Cosine Similarity | Оценка схожести векторов                 |	Используется для определения схожести между векторами запроса и товаров. Подходит для оценки релевантности товаров по смыслу, а не по точному совпадению слов. |
| XGBoost           |	Персонализация и ранжирование	           | Алгоритмы градиентного бустинга, подходящие для реранжирования и персонализации главной страницы. Позволяют учесть сложные зависимости между параметрами и поведением пользователя. |
| Pandas, SQL       |	Работа с данными пользователей	          | Применяются для анализа данных о действиях пользователей и управления таблицами с информацией о продуктах. Поддерживают удобные манипуляции с большими наборами данных. |
| nltk, spaCy       |	Обработка текста (NLP)                   |	Библиотеки для токенизации, лемматизации и других задач обработки текста, что важно для подготовки данных для моделей наивного байеса и других алгоритмов классификации. |
| PIL, OpenCV       |	Обработка изображений                    |	Инструменты для предобработки изображений, которые используются для автоматической модерации, включая изменение размера и нормализацию. |
| PyTorch           |	Обучение и разметка моделей              |	Популярный фреймворк для создания и обучения нейронных сетей, подходящие для задач, требующих работы с изображениями и текстами, включая модерацию и построение рекомендаций. |

<h2 id="9">9 Схема проекта</h2>

[Ссылка на схему проекта](https://drive.google.com/file/d/1843D7aB6kqBdhD87LkK3NdYXAH8yxSeq/view?usp=sharing)

![Highload Ivan Karpov SCHEME](https://github.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/blob/main/images/SCHEME_4.png)

<h2 id="10">10 Обеспечение надёжности</h2>

### Резервирование и масштабируемость приложений
| Компонент      | Метод                      | Обоснование                                                                                              |
| -------------- | -------------------------- | -------------------------------------------------------------------------------------------------------- |
| Nginx          | Резервирование серверов    | В случае высоких нагрузок и отказов балансировщика необходимо зарезервировать дополнительные серверы.    |
| MongoDB, PSQL  | Репликация                 | Обеспечивает доступность и целостность данных в случае отказа одного из серверов базы данных.            |
| Redis          |	Репликация (Master-Slave)  |	Для обеспечения доступности данных в случае отказа главной ноды Redis.                                   |
| Kafka          |	Репликация                 |	Обеспечивает отказоустойчивость и сохранность данных в случае отказа брокера.                            |
| ElasticSearch  |	Репликация индексов        |	Позволяет восстановить данные в случае отказа или повреждения индекса.                                   |
| ClickHouse     |	Репликация                 |	Для сохранности данных и равномерного распределения нагрузки.                                            |
| S3             |	Репликация	                | Обеспечивает доступность и сохранность данных в случае отказа одного из хранилищ.                        |
| Business Logic |	Резервирование компонентов |	В случае высоких нагрузок важно зарезервировать компоненты и серверы для обеспечения отказоустойчивости. |

### Резервирование инфраструктуры
*Резервирование дата-центров* - использование нескольких дата-центров (ЦОД) с географической изоляцией позволяет перераспределить нагрузку при сбое одного из ЦОД, обеспечив возможность восстановить данные или перенаправить трафик. В случае отказа DNS серверов, трафик автоматически перенаправляется в соседний ЦОД.

### Проектирование с учетом сбоев
*Graceful Shutdown* - использование данной практики позволяет завершить текущие процессы и корректно освободить ресурсы при отключении микросервисов, что минимизирует влияние на пользовательский опыт.

*Graceful Degradation* - в случае отказа части системы, сервисы могут продолжать работать с ограниченным функционалом, обеспечивая минимальную работоспособность:
1. Резервный поиск - при отказе основного поискового движка (ElasticSearch), система переключается на резервный механизм поиска, использующий другие базы данных (PostgreSQL). Это обеспечивает возможность пользователям продолжать искать товары с минимальными ограничениями по функционалу и точности.
2. Упрощенные рекомендации - при недоступности основного сервиса рекомендаций система отображает базовые варианты: популярные товары или последние добавленные. Это позволяет сохранять минимальный уровень персонализации и поддерживать интерес пользователей даже при сбоях.
3. Минимизация данных на странице товара - если недоступны некоторые вспомогательные сервисы (например, сервис отзывов), страница товара загружается с основными данными, такими как описание, цена, наличие, базовые характеристики. Визуально пользователи не замечают отсутствия части контента, что обеспечивает положительный опыт взаимодействия.

### Обработка сбоев и стратегии восстановления
*Повторные попытки (Retry)* - на уровне API Gateway и клиента могут быть настроены повторные попытки запросов, что уменьшает влияние краткосрочных сбоев.

### Мониторинг и наблюдаемость
*Мониторинг* - использование инструментов, таких как Prometheus, Grafana, для сбора и визуализации метрик, отслеживания состояния системы и мониторинга производительности.

*Алертинг* - настройка уведомлений и алертов позволяет оперативно реагировать на возникающие проблемы. Также важно использовать логирование с уникальными request id для трассировки запросов и диагностики проблем.

*Профилирование и тестирование* - регулярное профилирование системы помогает выявлять узкие места и улучшать производительность. Проводятся регулярные тренировки, например, отключение одного из ЦОД, чтобы убедиться в способности системы справиться с возможными сбоями.

### Асинхронные паттерны и отказоустойчивость в коммуникациях
*Kafka* - использование этой технологии для обеспечения согласованности данных и координации транзакций между микросервисами в распределенной среде.

*CQRS и Backend for Frontend* - изоляция логики и разделение операций чтения и записи помогает улучшить производительность и снизить нагрузку на базу данных.

<h2 id="11">11 Список серверов</h2>

### Веб-серверы (Nginx)
На официально сайте nginx видно, что сервер с 16 CPU видерживает 77 427 HTTP RPS
![Highload Ivan Karpov NGINX_CONF](https://github.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/blob/main/images/nginx_conf.png)

Данные:
* Пиковое значение по RPS для всего трафика: 164670 RPS
* Пиковое значение сетевого трафика: 8.2142 Гбит/с
Расчет по RPS: 1 сервер Nginx с 16 CPU поддерживает 77 427 RPS.
Для расчета количества серверов по RPS:
```
164,670RPS / 77,427RPS = 2.13 серверов
```

Округляем до 3 серверов.
Расчет по сетевому трафику: 1 сервер с 40 Гбит/с может обрабатывать до 40 Гбит/с.
Для сетевого трафика:
```
8.2142Гбит/с / 40Гбит/с = 0.205 серверов
```
Округляем до 1 сервера.
Таким образом, для веб-сервера Nginx потребуется 3 сервера (по RPS).
При расчёте количества на один ДЦ учтём, что для каждого сервера необходимо резервирование. С учетом 5 ДЦ получаем следующее распределение:

Параметр |	Значение
-------- | --------
CPU      |	16
Network  |	40 ГБит/с
Кол-во	  | 30

### Микросервисы
Предположим, что каждый сервис будет иметь такую же нагрузку по RPS, как и весь проект. Для каждого микросервиса рассчитаем нужное количество серверов.
В среднем, язык программирования Go поддерживает 38 900 RPS с учётом запросов в СУБД, по данным нескольких источников.

Пример для Auth:
* RPS: 642 984
* 1 сервер с 16 ядрами поддерживает 38 900 RPS.
Для расчета серверов по RPS:
```
109,780 / 38,900 = 2.82 серверов
```
Округляем до 3 серверов.

Рассчитаем количество серверов по сетевому трафику для Auth:
* Сетевой трафик для Auth: 66.8 Гбит/с
```
66.8 / 40 = 1.67 серверов
```
Округляем до 2 серверов.

Микросервисы для вашего проекта: Для каждого сервиса расчет выполняется по аналогичной схеме. 

Сервис         |	RPS     |	Серверы по RPS |	Сетевой трафик (Гбит/с) |	Серверы по трафику	| Итого серверов | Итого серверов с резервированием | Итого серверов на все ДЦ
-------------- | ------- | -------------- | ----------------------- | ------------------ | -------------- | -------------------------------- | -------------------------
Auth           | 109,780 |	3              |	66.8                    |	2                  |	3              | 6                                | 30
Search         |	839     |	1              |	0.0084                  |	1                  |	1              | 2                                | 10
Profile        |	280     |	1              |	0.0053                  |	1                  |	1              | 2                                | 10
Cart           |	1,120   |	2              |	0.007                   |	1                  |	2              | 4                                | 20
Order          |	280     |	1              |	0.0053                  |	1                  |	1              | 2                                | 10
Product        |	2,800   |	4              |	0.021                   |	1                  |	4              | 8                                | 40
Comment        |	560     |	1              |	0.0035                  |	1                  |	1              | 2                                | 10
Analytics      |	841     |	1              |	0.0063                  |	1                  |	1              | 2                                | 10
Media          |	945     |	1              |	0.0067                  |	1                  |	1              | 2                                | 10
Moderation     |	841     |	1              |	0.0063                  |	1                  |	1              | 2                                | 10
Location	      | 280     |	1              |	0.0053                  |	1                  |	1              | 2                                | 10
Recommendation |	839     |	1              |	0.0084                  |	1                  |	1              | 2                                | 10
Company        |	280     |	1              |	0.0053                  |	1                  |	1              | 2                                | 10
Итого          |	—       |	19             |	-                       |	14                 |	19             | 38                               | 190

*Покупка или аренда серверов?*
Название |	Хостинг |	Конфигурация                                     |	Cores |	Количество |	Покупка	  | Аренда
-------- | ------- | ------------------------------------------------ | ----- | ---------- | --------- | -----------
kubenode |	У себя  |	2xXeon Gold 6248R/16x128GB/2xNVMe2T/2x25Gb/s     |	64	   | 190        |	$9500000  |	$132000/мес

Окупаемость серверов в сравнении с арендой будет достигнута в течение *6* лет.

### Контейнеры для микросервисов

Контейнер      |	CPU (ядра) |	RAM (ГБ)
-------------- | ---------- | --------
nginx	         | 2          |	4
Auth	          | 4	         | 8
Search         |	2          |	4
Profile	       | 1          |	2
Cart	          | 2          |	4
Order	         | 1          |	2
Product	       | 2          |	4
Comment	       | 2	         | 4
Analytics      |	2	         | 4
Media	         | 2          |	4
Moderation     |	2          |	4
Location       |	1          |	2
Recommendation |	2	         | 4
Company        |	1	         | 2

Объяснение контейнеров:
* nginx: Использует 2 ядра CPU и 4 ГБ RAM для обработки запросов.
* Auth: Поскольку этот сервис имеет самую большую нагрузку по RPS и сетевому трафику, ему требуется больше ресурсов — 4 ядра CPU и 8 ГБ RAM.
* Для остальных микросервисов ресурсы будут пропорциональны их нагрузке. Например, сервисы с меньшей нагрузкой, такие как Profile, Order, Location, могут работать с меньшими ресурсами (1 ядро CPU и 2 ГБ RAM).

### Базы данных
Для работы с данными нам потребуется настроить несколько баз данных:
* Redis - используется для хранения сессий (in-memory). 9 серверов (3 master + 6 replicas), с учетом 55.2 млн пользователей.
* PostgreSQL - pеляционные таблицы с отношениями. Кластер из 6 серверов: 2 master + 4 slave + реплики, с учетом высокой доступности и транзакционной нагрузки.
* ClickHouse - для аналитики и быстрого чтения больших данных. Подойдет кластер из 8 серверов (16 CPU, 64 GB RAM).
* ElasticSeacrh - для полнотекстового поиска по товарам и компаниям. С учетом индексации больших данных потребуется 7 серверов.
* Kafka - для обработки событий. Требуется кластер Kafka, предполагаем ~12 брокеров для обработки событий в реальном времени.
* MongoDB - для MongoDB потребуется кластер из 40 серверов (4 master + 16 реплики).
* AWS S3 - 230 серверов с дисками объемом 10 ТБ.

База данных   |	Серверы |	CPU (на сервер) |	RAM (на сервер) |	ROM (на сервер) | Итого серверов с резервированием | Итого серверов на все ДЦ
------------- | ------- | --------------- | --------------- | --------------- | -------------------------------- | -------------------------
Redis         |	9       |	2               |	32 GB           | 20 GB           | 18                               | 90
PostgreSQL    |	6       |	24              |	512 GB	         | 5 TB            | 12                               | 60
ClickHouse    |	8       |	16              |	64 GB           |	10-20 TB        | 16                               | 80
Elasticsearch |	7       |	16              |	64 GB           |	2 TB            | 14                               | 70
Kafka         |	12      |	16              |	64 GB           |	2 TB            | 24                               | 120
MongoDB       |	40      | 24              |	64 GB           |	5 TB            | 80                               | 400
AWS (S3)      | 230     | 64              | 512 GB          | 100 TB          | 460                              | 2300
Итого         | 301     |                 |                 |                 | 602                              | 3010

Общее количество серверов: 3010.

<h2 id="sources">Список источников</h2>

1. https://www.similarweb.com/ru/website/wildberries.ru/#demographics
2. https://oborot.ru/news/kolichestvo-posetitelej-marketplejsov-wildberries-i-ozon-v-mesyac-sravnyalos-kuda-eshhe-hodyat-pokupateli-i209527.html
3. https://dzen.ru/a/ZkT8wKCKkBgtJMT-
4. https://adindex.ru/news/researches/2023/02/28/310879.phtml
5. https://dzen.ru/a/ZkT8wKCKkBgtJMT-
6. https://www.vedomosti.ru/business/articles/2024/05/05/1035562-ozon-i-wildberries
7. https://www.cnews.ru/news/line/2023-06-08_wildberries_itogi_i_kvartala_2023
