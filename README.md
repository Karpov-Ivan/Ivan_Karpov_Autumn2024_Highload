# Проектирование высоконагруженного сервиса интернет-магазина

---

<h3 id="Content">Содержание</h3>

#### 1. [Тема и целевая аудитория](#1)
#### 2. [Расчет нагрузки](#2)
#### 3. [Глобальная балансировка нагрузки](#3)
#### 4. [Локальная балансировка нагрузки](#4)
#### 5. [Логическая схема базы данных](#5)
#### 6. [Физическая схема базы данных](#6)
#### 7. [Алгоритмы](#7)

#### [Источники](#sources)

---

<h2 id="1">1 Тема и целевая аудитория</h2>

## Тема
Маркетплейс Wildberries — российский международный интернет-магазин, предлагающий одежду, обувь, электронику, детские товары, товары для дома и другие категории товаров.

## MVP
1. Авторизация, регистрация по номеру телефона.
2. Поиск товаров по ключевым словам.
3. Главная страница персонализированных предложений.
4. Добавление товаров в корзину.
5. Редактирование количества и удаление товаров.
6. Оставление отзывов о приобретённых товарах.
7. Оформление заказа.
8. Статус заказа при доставке.
9. Добавление товаров продавцом на площадку с учётом фотографии.
10. Авторизация, регистрация для продавцов.
11. Открытие карточки товара.

## Продуктовые особенности
* Платежная система — удобная и безопасная система оплаты, которая поддерживает различные способы оплаты (банковские карты, электронные кошельки и другие), гарантируя комфорт и безопасность транзакций для пользователей.

## ЦА
Ниже представлена статистика исследования аудитории Wildberries.
Возраст целевой аудитории варьируется в диапазоне от 18 до 65+ лет. [[1]](https://www.similarweb.com/ru/website/wildberries.ru/#demographics)
Возрастная группа | Процентное соотношение
------------------| -------------
18-24 года        | 14,31% 
25-34 года        | 23,79% 
35-44 года        | 18,11% 
45-54 года        | 17,53% 
55-64 года        | 14,78% 
65+   года        | 11,48% 

Размер целевой аудитории: 58.7 млн. пользователей в месяц, 24.2 млн. пользователей в день на момент февраля 2024г. [[2]](https://oborot.ru/news/kolichestvo-posetitelej-marketplejsov-wildberries-i-ozon-v-mesyac-sravnyalos-kuda-eshhe-hodyat-pokupateli-i209527.html)

География пользователей:
Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 93.05%
Беларусь     | 2.06% 
Казахстан    | 1.74%
Армения      | 0.53% 
Другие       | 2.63% 

Гендерное распределение аудитории Wildberries [[3]](https://dzen.ru/a/ZkT8wKCKkBgtJMT-):
Пол          | Процентное соотношение
-------------| -------------
Мужской      | 30.00%
Женский      | 70.00% 

<h2 id="2">2 Расчёт нагрузки</h2>

Продуктовые метрики:
Метрика                                                                                         | Значение
------------------------------------------------------------------------------------------------| -----------------------
Месячная аудитория MAU                                                                          | 58.7 млн. пользователей
Дневная аудитория DAU                                                                           | 24.2 млн. пользователей
Количество регистраций в день [[4]](https://adindex.ru/news/researches/2023/02/28/310879.phtml) | 40 тыс. пользователей
Средняя длительность сессии   [[5]](https://dzen.ru/a/ZkT8wKCKkBgtJMT-)                         | 11 минут

### Хранилище данных для пользователя

Параметр                                                | Число
--------------------------------------------------------| -----------------
Поиск товаров по ключевым словам                        | 3 запросов/день
Добавление товаров в корзину                            | 4 товаров/день
Оформление заказа                                       | 1 заказов/день
Среднее количество товаров в заказе                     | 3 товаров
Оставление отзывов                                      | 2 отзывов/день
Средняя длина отзыва                                    | 60 символов UTF-8
Средний количество фотографий у отзыва                  | 3 шт.
Добавление товаров продавцом                            | 1 товаров/день
Средний размер товара без учета фотографии              | 6.3 кБ
Средний количество фотографий у товара                  | 7 шт.
Средний размер фотографии товара                        | 86 кБ
Главная страница персонализированных предложений        | 20 товаров/день
Добавление товаров продавцом                            | 4 товаров/день
Редактирование количества и удаление товаров из корзины | 2 товаров/день
Открытие карточки товара                                | 10 товаров/день
Статус заказа при доставке                              | 3 запроса/день

Объём данных на одного пользователя в день:
* Добавление товаров в корзину: 4 товара * 6.3 кБ = 25.2 кБ
* Оформление заказа: 3 товара * 6.3 кБ = 18.9 кБ
* Оставление отзывов: 2 отзыва * (0.06 кБ + 3 * 86 кБ) = 467.72 кБ
* Главная страница персонализированных предложений: 20 товаров * 6.3 кБ = 126 кБ.
* Добавление товаров продавцом: 4 товаров * (6.3 кБ + 7 * 86 кБ) = 4 товаров * 2461.2 кБ = 9844.8 кБ.
* Редактирование количества и удаление товаров из корзины: 2 товаров * 6.3 кБ = 12.6 кБ.
* Открытие карточки товара: 10 товаров * (6.3 кБ + 17 отзывов * 0.06 кБ) = 10 товаров * 7.32 кБ = 73.2 кБ.
* Статус заказа при доставке: 3 запроса * 7.6 кБ = 22.8 кБ
* Загрузка медиа: 48 * 86 кБ = 4128 кБ

Тогда общий объем товаров в день, добавляемых в корзину, оформленых в заказе, оставление отзывов, получение главной ленты на одного пользователя равен: 
4 * 6.3 (кБ) + 3 * 6.3 (кБ) + 2 * (0.06 (кБ) + 3 * 86 (кБ)) + 20 * 6.3 (кБ) + 4 * (6.3 (кБ) + 7 * 86 (кБ)) + 2 * 6.3 (кБ) + 10 * (6.3 (кБ) + 7 * 86 (кБ)) + 3 * 7.6 (кБ) + 48 * 86 (кБ) = 14719.22 кБ = 14.7 МБ

### Динамический рост

Так как за год заказывается около 618 млн. [[7]](https://www.cnews.ru/news/line/2023-06-08_wildberries_itogi_i_kvartala_2023) товаров, то можно вычислить, какой объем данных будет занят пользователями:
* Расчёт данных на товары (всего): 6.3 (кБ) * 618 млн. = 3.9 ТБ
* Расчёт данных только на фотографии товаров: 7 * 86 (кБ) * 618 млн. = 372.04 ТБ

### Сетевой трафик
При расчете сетевого трафика не будем учитывать запросы, связанные с регистрацией пользователей, так как они не создают ощутимую нагрузку на наш сервис.
Основная нагрузка приходится на оформление заказа, добавление в корзину и оставление отзывов.

### Предварительные расчеты:
### Трафик по видам активности на одного пользователя:
1. Поиск товаров:

* 3 запроса/день. Примерный объем одного запроса можно оценить в 10 кБ (запрос + ответ от сервера). Итого: 3 ∗ 10 кБ = 30 кБ

2. Добавление товаров в корзину:

* 4 товара/день. Объем данных на один товар — 6.3 кБ. Итого: 25.2 кБ

3. Оформление заказа:

* 1 заказ в день с 3 товарами. Итого: 18.9 кБ

4. Оставление отзывов:

* 2 отзыва/день, 467.72 кБ (как рассчитано ранее). Итого: 467.72 кБ

5. Главная страница персонализированных предложений:

* 20 товаров/день, 126 кБ (как рассчитано ранее). Итого: 126 кБ

6. Добавление товаров продавцом:

* 4 товаров/день, 9844.8 кБ (как рассчитано ранее). Итого: 9844.8 кБ

7. Редактирование количества и удаление товаров из корзины:

* 2 товаров/день, 12.6 кБ (как рассчитано ранее). Итого: 12.6 кБ

8. Открытие карточки товара:

* 10 товаров/день и 17 отзывов для каждого товара, 73.2 кБ (как рассчитано ранее). Итого: 73.2 кБ

9. Статус заказа при доставке:

* 3 запроса/день, 22.8 кБ (как рассчитано ранее). Итого: 22.8 кБ

10. Медиа в день со всех ручек:

* 48 медиа/день, 4128 кБ (как рассчитано ранее). Итого: 4128 кБ

10. Трафик на одного пользователя в день:

* 30 кБ + 25.2 кБ + 18.9 кБ + 467.72 кБ + 126 кБ + 9844.8 кБ + 12.6 кБ + 73.2 кБ + 22.8 кБ + 4128 кБ = 14719.22 кБ = 14.7 МБ

### Сетевой трафик по видам активности (дневная аудитория 24.2 млн. пользователей):

Пиковое значение активности пользователей(соответственно RPS тоже) приблизительно в 1.66 раза выше среднего значения. Возьмем коэффициент запаса равный 2

Тип                           | Отправка (дневная аудитория 24.2 млн) | Отправка Гб/сек | Пиковое значение | Значение с коэффициентом запаса 2 |
------------------------------| --------------------------------------| ----------------| -----------------|---------------------------------- |
Поиск товаров                 | 24.2 млн * 30 кБ = 726 ГБ             | 0.0084          | 0.0139           | 0.0168                            |
Добавление товаров в корзину  | 24.2 млн * 25.2 кБ = 609.84 ГБ        | 0.007           | 0.0117           | 0.014                             |
Оформление заказа             | 24.2 млн * 18.9 кБ = 457.38 ГБ        | 0.0053          | 0.0088           | 0.0106                            |
Оставление отзывов            | 24.2 млн * 467.72 кБ = 11 314 ГБ      | 0.131           | 0.217            | 0.262                             |
Главная страница              | 24.2 млн * 126 кБ = 3049.2 ГБ         | 0.035           | 0.0581           | 0.07                              |
Редактирование корзины        | 24.2 млн * 12.6 кБ = 304.92 ГБ        | 0.0035          | 0.00581          | 0.007                             |
Добавление товаров продавцом  | 24.2 млн * 9844.8 кБ = 236.28 ТБ      | 2.734           | 4.538            | 5.468                             |
Открытие карточки товара      | 24.2 млн * 73.2 кБ = 1771.44 ГБ       | 0.021           | 0.035            | 0.042                             |
Статус заказа при доставке    | 24.2 млн * 22.8 кБ = 551.76 ГБ        | 0.0063          | 0.011            | 0.0126                            |
Медиа                         | 24.2 млн * 4128 кБ = 99.8976 ТБ       | 1.156           | 1.92             | 2.312                             |
Итого                         | 354961.98 ГБ = 354.96 	ТБ             | 4.1071          | 6.8179           | 8.2142                            |

### RPS
 
* Поиск товаров: 24.2 млн * 3 / 86400 = 839 RPS
* Добавление товаров в корзину: 24.2 млн * 4 / 86400 = 1120 RPS
* Оформление заказов: 24.2 млн. * 1 / 86400 = 280 RPS
* Оставление отзывов: 24.2 млн. * 2 / 86400 = 560 RPS
* Добавление товаров продавцом: 24.2 млн. * 1 / 86400 = 280 RPS
* Главная страница персонализированных предложений: 24.2 млн * 20 / 86400 = 5600 RPS
* Редактирование количества и удаление товаров из корзины: 24.2 млн * 2 / 86400 = 560 RPS
* Добавление товаров продавцом: 24.2 млн * 4 / 86400 = 1120 RPS
* Открытие карточки товара: 24.2 млн * 10 / 86400 = 2800 RPS
* Статус заказа при доставке: 24.2 млн * 3 / 86400 = 841 RPS
* Загрузка медиа: 24.2 млн * 48 / 86400 = 13445 RPS

Действие                            | RPS   | Пиковое значение | Пиковое значение с коэффициентом запаса 2  |
------------------------------------| ------| -----------------| ------------------------------------------ |
Поиск товаров                       | 839   | 1393             | 2786                                       |
Добавление товаров в корзину        | 1120  | 1859             | 3718                                       |
Оформление заказов                  | 280   | 465              | 930                                        |
Оставление отзывов                  | 560   | 930              | 1860                                       |
Добавление товаров продавцом        | 280   | 465              | 930                                        |
Главная страница                    | 5600  | 9296             | 11200                                      |
Редактирование корзины              | 560   | 930              | 1120                                       |
Добавление товаров продавцом        | 1120  | 1860             | 2240                                       |
Открытие карточки товара            | 2800  | 4648             | 5600                                       |
Статус заказа при доставке          | 841   | 1396             | 1682                                       |
Загрузка медиа                      | 13445 | 22318            | 26890                                      |
**Итого**                           | 27445 | 45558            | 54890                                      | 

<h2 id="3">3 Глобальная балансировка нагрузки</h2>

### География пользователей

Целевая аудитория Wildberries распределена в основном по странам СНГ, с преобладанием в России. Вот как распределяются пользователи по регионам:

Страна       | Процентное соотношение
-------------| ----------------------
Россия       | 93.05%
Беларусь     | 2.06% 
Казахстан    | 1.74%
Армения      | 0.53% 
Другие       | 2.63% 

Это определяет необходимость расположения датацентров (ДЦ) преимущественно в России и других странах СНГ для обеспечения низкой задержки и высокой производительности.

### Функциональное разбиение по доменам

Для оптимизации работы и распределения нагрузки по различным функциональным модулям можно применить функциональное разбиение по доменам. Это позволяет отдельным частям системы работать независимо друг от друга, улучшая масштабируемость и отказоустойчивость.

Примеры функциональных доменов:

* wildberries.ru — API-сервисы для мобильных приложений и веб-версии.
* cdn.wildberries.ru — доставка медиа-контента (фото товаров, видео, баннеры).
* wbxoofex.wildberries.ru — сервис оформления заказов и управления корзиной.
* search.wb.ru — отдельный домен для поиска товаров.
* seller.wildberries.ru — платформа для продавцов.

Такое разбиение позволяет улучшить управляемость трафика, распределять нагрузку на отдельные системы, а также внедрять более гибкие методы балансировки.

### Обоснование расположения ДЦ

На основе [географии пользователей](https://map.wb.ru/#2/53.05/127.13) можно обосновать расположение датацентров. Основная цель — снизить сетевые задержки и улучшить производительность для конечных пользователей.

Страна    | Локация ДЦ                | Обоснование
----------| --------------------------| ---------------------------------------------------------------------------------------------------
Россия    |	Москва                 	  | 93.05% пользователей из России, оптимизация для западной части страны
Россия    |	Санкт-Петербург	          | 93.05% пользователей из России, оптимизация для западной части страны
Россия    |	Новосибирск	              | Покрытие для пользователей Центральной России, Урала, Сибири, восточных регионов и Дальнего Востока
Беларусь  |	Минск	                    | Поддержка пользователей Беларуси (2.06%)
Казахстан |	Алматы	                   | Покрытие для пользователей Казахстана (1.74%)

Основное внимание уделяется России, так как большинство пользователей находится в этой стране. Однако наличие датацентров в соседних странах (Беларусь, Казахстан, Армения) помогает улучшить доступ к сервису и уменьшить задержки для пользователей этих регионов.

### Схема DNS-балансировки

Latency-Based DNS с использованием BGP-маршрутизации

Latency-Based DNS-балансировка направляет запросы пользователей на ближайший датацентр с наименьшей задержкой, оценивая это на основе метрик задержек в сети (latency) и BGP-маршрутов.

Алгоритм работы:
1. Пользовательский запрос: Пользователь отправляет запрос на домен.
2. Определение ближайшей BGP-подсети:
* DNS-сервер анализирует местоположение пользователя на основе IP-адреса. Это осуществляется за счёт баз данных, сопоставляющих IP с географической зоной и BGP-подсетью.
* DNS-сервер затем отправляет ICMP-запросы или использует протоколы мониторинга сети для замера latency (времени задержки) до ближайших датацентров в различных BGP-подсетях.
* По результатам измерений DNS выбирает BGP-подсеть с минимальной задержкой.
3. Маршрутизация на уровне BGP:
* После определения ближайшей BGP-подсети, запрос пользователя направляется в эту подсеть.
* Внутри выбранной BGP-подсети происходит более детальный анализ задержек между несколькими датацентрами. Например, если в выбранной подсети есть несколько датацентров, то на этом этапе измеряются задержки между пользователем и каждым из них.
4. Перенаправление на конкретный датацентр:
* После оценки задержек между всеми доступными датацентрами в выбранной BGP-подсети, запрос направляется в датацентр с наименьшей задержкой.
* Если ближайший датацентр перегружен или недоступен, механизм автоматически переключает запрос на следующий ближайший датацентр в этой же BGP-подсети с минимальной задержкой.

<h2 id="4">4 Локальная балансировка нагрузки</h2>

L3:
L3 будет использоваться в качестве первичной балансировки, чтобы распределить трафик по серверам внутри ЦОД. Балансировка будет по схеме Virtual Server via IP Tunneling

![image](https://raw.githubusercontent.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/refs/heads/main/images/311767474-de3f99a0-3714-429c-b93a-7ac53e610c17.png)


Для обеспечаения отказоустойчивости системы стоит использовать framework *keepalived* благодаря следующим преимуществам:
* Производительность
* Открытость
* Простота настройки

Будем использовать **Virtual Router Redundancy Protocol(VRRP)**. Соответственно, мы получаем возможность отслеживать состояние узлов системы, а при отказе одного из них перенаправить трафик на другой узел.

L7:
На отдельно взятом сервере будет проходить балансировка с помощью L7. На этом уровне для балансировщика нагрузки важна поддержка HTTP-заголовков. Будем использовать балансировщик NGINX благодаря следующим преимуществам:
* Лучшая производительность
* Поддержка различных протоколов(в т.ч. gRPC и HTTP)
* Открытость
* Гибкость настройки

Также для решения проблемы отказоустойчивости на этом уровне будет использоваться k8s с использованием:
* Liveness probe
* Readiness probe

Для шифрования будем пользоваться услугами центра [Let's encrypt](https://letsencrypt.org)
Для оптимизации установки соединения будет пользоваться Session cache

<h2 id="5">5 Логическая схема базы данных</h2>

## Схема базы данных
[Ссылка на логическую схему БД](https://dbdiagram.io/d/6702ea1cfb079c7ebd82a4c2)

![Highload Ivan Karpov DB](https://github.com/Karpov-Ivan/Ivan_Karpov_Autumn2024_Highload/blob/main/images/DB_WB_3.png)

**PRODUCT -> FILE_ID**
```bash
{
  "main_image": "https://s3.amazonaws.com/mybucket/main_image.jpg",
  "gallery": [
    "https://s3.amazonaws.com/mybucket/image1.jpg",
    "https://s3.amazonaws.com/mybucket/image2.jpg"
  ]
}
``` 
---
**PRODUCT -> ATTRIBUTES**
```bash
{
  "sizes": ["S", "M", "L", "XL"],
  "color": "red",
  "weight": "1.2 kg",
  "material": "cotton",
  "dimensions": {
    "width": "30 cm",
    "height": "50 cm",
    "depth": "10 cm"
  }
}
``` 
---
**COMMENT -> FILE_ID**
```bash
{
  "main_image": "https://s3.amazonaws.com/mybucket/main_image.jpg",
  "gallery": [
    "https://s3.amazonaws.com/mybucket/image1.jpg",
    "https://s3.amazonaws.com/mybucket/image2.jpg"
  ]
}
``` 
---
**ORDER_ITEM -> STATUS**
```bash
{
  "current_status": "delivered", // Текущий статус заказа
  "history": [
    {
      "status": "pending", // Статус: ожидается
      "updated_at": "2024-10-01T12:00:00Z" // Дата изменения статуса
    },
    {
      "status": "shipped", // Статус: отправлен
      "updated_at": "2024-10-02T08:30:00Z"
    },
    {
      "status": "delivered", // Статус: доставлен
      "updated_at": "2024-10-03T14:45:00Z"
    }
  ]
}
``` 
---
**ORDER_ITEM -> ITEMS**
```bash
[
  {
    "product_id": "uuid1",
    "quantity": 2,
    "price": 1000
  },
  {
    "product_id": "uuid2",
    "quantity": 1,
    "price": 500
  }
]
``` 
---

Тип       | Размер в байтах
----------| --------------------------------------------------
uuid      | 16
int       | 4
numeric   | 8
timestamp | 8
boolean   | 1
text      | Динамический, зависит от длины (1 символ ≈ 1 байт)

<h2 id="6">6 Физическая схема базы данных</h2>

Таблица | Технология | Обоснование
--------| -----------| -----------------------------------------------------------------------------------------------------------------------------------------------------
Session | Redis      | Redis подходит для хранения сессий благодаря in-memory хранению данных и высокой производительности при работе с временными данными (TTL). Также есть поддержка организации кластера Redis cluster и неблокирующей репликации master-slave.
Profile, Address, Company, Product, Category, File, Comment, Order_Info, Moderation, Country, City, Street, House, Apartment | PostgreSQL | Реляционные таблицы с отношениями и строгой структурой данных. PostgreSQL предоставляет мощные возможности для работы с транзакциями и обеспечит целостность данных (например, связи между профилями, товарами, заказами и прочим).
Product_Stats, Product_Rating, Comment_Stats, Shopping_Cart_Item | ClickHouse | ClickHouse - колоночная база данных, предназначенная для быстрого чтения и анализа больших объемов данных. ClickHouse отличается высокой производительностью при чтении, особенно при агрегации данных. ClickHouse оптимизирован для быстрой вставки больших объемов данных. Он использует механизм "append-only", где новые данные добавляются в конец таблицы, что ускоряет процесс. 
Product_ElasticSearch, Company_ElasticSearch | Elasticsearch | Для полнотекстового поиска по товарам используем Elasticsearch. Он поддерживает высокоэффективный поиск по ключевым словам и легко интегрируется с системой благодаря API.
File_S3 | AWS S3 | Хранение больших файлов (фотографий и других медиа) будет производиться в облачном хранилище. AWS S3 предоставляет высокую доступность, репликацию данных и простое управление большими объемами файлов.
Kafka_Product_Event, Kafka_Company_Event, Kafka_Comment_Event, Kafka_Product_Rating_Event | Kafka | Kafka используется для обработки и передачи событий в режиме реального времени. Эти таблицы представляют собой временные хранилища событий из Kafka, таких как действия пользователей (просмотры, клики, рейтинги, комментарии). Kafka обеспечивает надежную доставку сообщений и масштабирование, что делает его подходящим для обработки высоконагруженных систем, где необходимо передавать события между различными компонентами системы.

### Индексы:
Индексация критически важна для оптимизации работы с базой данных. Добавим индексы на часто используемые поля:
1) Session:
* Индекс по полю token, так как оно является основным для идентификации сессии.
* Индекс по полю profile_id для быстрого доступа к профилю пользователя.
* Индекс по полю last_access_at для удаления или поиска неактивных сессий.
2) Profile:
* Индекс на поле login, чтобы ускорить поиск пользователей по логину.
* Индекс на поле phone, поскольку регистрация и авторизация может выполняться по номеру телефона.
* Индекс на поле statusDeleted, чтобы эффективно фильтровать активных и удалённых пользователей.
3) Address:
* Индекс на поле profile_id, так как запросы на получение адресов будут связаны с конкретным пользователем.
* Индексы на поля country_id, city_id, и street_id для ускорения поиска по местоположению (страна, город, улица).
4) Country:
* Индекс на поле name, поскольку поиск будет происходить по названию страны.
5) City:
* Индекс на поле country_id, чтобы быстро находить города внутри определённой страны.
* Индекс на поле name для поиска по названию города.
6) Street:
* Индекс на поле city_id для поиска улиц в рамках конкретного города.
* Индекс на поле name, поскольку могут быть запросы по названию улицы.
7) House:
* Индекс на поле street_id для быстрого поиска домов на конкретной улице.
8) Apartment:
* Индекс на поле house_id, чтобы быстро находить квартиры в определённом доме.
9) Product:
* Индекс на поле id для поиска товаров по идентификатору.
* Индекс на поле name для поиска товаров по названию.
* Индекс на поле category_id для фильтрации товаров по категориям.
* Индекс на поле company_id для ускорения выборки товаров определённого продавца.
* Индекс на поле price для эффективной сортировки по цене.
10) Product_ElasticSearch:
* Индексы на поля name и description для быстрого полнотекстового поиска по товарам.
11) Product_Rating:
* Индекс на поле product_id для быстрого доступа к рейтингу товара.
12) Product_Stats:
* Индекс на поле product_id для отслеживания статистики по каждому товару.
13) Category:
* Индекс на поле name для поиска категорий по названию.
* Индекс на поле parent для поиска подкатегорий.
14) File:
* Индекс на поле link_file для быстрого доступа к файлам по их ссылкам.
15) Comment: 
* Индекс на поле product_id для получения всех комментариев к продукту.
* Индекс на поле profile_id для отслеживания комментариев от конкретного пользователя.
16) Comment_Stats:
* Индекс на поле comment_id для работы со статистикой конкретных комментариев.
17) Shopping_Cart_Item:
* Индекс на поле profile_id для поиска всех товаров в корзине пользователя.
* Индекс на поле product_id для быстрого доступа к товарам в корзине.
18) Order_Info:
* Индекс на поле profile_id для поиска заказов конкретного пользователя.
* Индекс на поле address_id для поиска заказов по адресу доставки.
19) Company:
* Индекс на поле inn для поиска компаний по ИНН.
20) Moderation:
* Индекс на поле product_id для ускорения модерации конкретного товара.
21) Company_ElasticSearch:
* Индексы на поля name, inn, profile_id для быстрого полнотекстового поиска магазина.
22) Kafka_Product_Event:
* Индекс на поле product_id для быстрого доступа к событиям, связанным с конкретным продуктом.
* Индекс на поле event_type для эффективной фильтрации событий по типу (например, "view", "click", "purchase").
* Индекс на поле event_time для сортировки событий по времени и выполнения запросов с временными диапазонами.
* Индекс на поле processed для эффективной выборки необработанных событий.
23) Kafka_Company_Event:
* Индекс на поле company_id для быстрого доступа к событиям, связанным с конкретной компанией.
* Индекс на поле event_type для фильтрации по типу событий (например, "product_added", "moderation_completed").
* Индекс на поле event_time для сортировки событий по времени.
* Индекс на поле processed для эффективной выборки необработанных событий.
24) Kafka_Comment_Event:
* Индекс на поле comment_id для быстрого поиска событий, связанных с конкретным комментарием.
* Индекс на поле event_type для фильтрации по типу событий (например, "view", "rating_updated").
* Индекс на поле event_time для сортировки и фильтрации по временным диапазонам.
* Индекс на поле processed для ускорения выборки необработанных событий.
25) Kafka_Product_Rating_Event:
* Индекс на поле product_id для быстрого доступа к событиям, связанным с рейтингами конкретного продукта.
* Индекс на поле event_type для фильтрации по типу события (например, "new_rating", "comment_added").
* Индекс на поле event_time для эффективной сортировки событий по времени.
* Индекс на поле processed для быстрого поиска необработанных событий.

### Шардирование и резервирование:
Шардирование позволит распределить нагрузку на базу данных, избегая узких мест и повышения отказоустойчивости:
1) PostgreSQL:
* Шардирование по товарам (Product, Product_Stats, Product_Rating, Comment): Шардирование по product_id. Это позволит распределить нагрузку, так как данные товаров (включая статистику, рейтинги, отзывы) часто запрашиваются вместе.
* Шардирование заказов (Order_Info): Шардирование по profile_id, чтобы распределить нагрузку между пользователями. История заказов обычно запрашивается индивидуально.
* Репликация: Для PostgreSQL имеет смысл настроить мастер-репликацию для обработки запросов на чтение из реплик, а записи вести в основной инстанс. Это увеличит производительность и отказоустойчивость.
2) Redis:
* Репликация: Master-slave репликация для Redis для обеспечения отказоустойчивости.
3) Elasticsearch:
* Шардирование: Elasticsearch поддерживает внутреннее шардирование, которое можно настроить на уровне конфигурации. Рекомендуется шардировать по ключевым полям поиска (например, по name).

### Схема резервного копирования:
1) PostgreSQL:
* Использование pg_dump для регулярного создания бэкапов базы данных. Бэкапы сохраняются на удаленный сервер или в облачное хранилище (например, S3).
2) Redis:
* Redis поддерживает сохранение снимков данных через RDB (Redis Database Backup) и AOF (Append Only File). RDB можно использовать для периодических полных бэкапов, а AOF для сохранения журнала операций.
3) Elasticsearch:
* Использование встроенной системы снапшотов Elastic для регулярных бэкапов данных в удаленное хранилище (например, S3).
4) AWS S3:
* Файлы на S3 защищены встроенной системой версионирования и высокой доступностью. Рекомендуется использовать Glacier для долгосрочного хранения архивных данных.
5) ClickHouse:
* ClickHouse поддерживает резервное копирование через встроенные механизмы создания снапшотов и репликацию. Снимки (snapshots) можно сохранять локально или в удаленное хранилище (например, S3).
6) Kafka:
* Kafka поддерживает репликацию журналов сообщений между брокерами, что обеспечивает высокую доступность и отказоустойчивость. Для создания резервных копий можно использовать специальные утилиты, такие как MirrorMaker, который дублирует данные в другом кластере Kafka, или сохранять данные на внешние носители.

### Клиентские библиотеки:
1) PostgreSQL:
Для работы с PostgreSQL в Go часто используют следующие библиотеки:
- [pgx](https://github.com/jackc/pgx): Один из самых популярных и мощных драйверов для работы с PostgreSQL. Поддерживает транзакции, мультиплексирование соединений, и работу с подготовленными запросами.
- [GORM](https://gorm.io/): ORM для Go, который поддерживает PostgreSQL. Позволяет работать с базой данных на высоком уровне, используя объекты и запросы на уровне сущностей.
2) Redis:
Для интеграции с Redis в Go можно использовать следующие библиотеки:
- [go-redis](https://github.com/go-redis/redis): Самая популярная библиотека для работы с Redis в Go. Поддерживает основные команды Redis, работу с кластерами и транзакциями.
3) Elasticsearch:
Для работы с Elasticsearch в Go можно использовать клиентскую библиотеку, разработанную самими разработчиками Elasticsearch:
- [Elastic Go Client](https://github.com/elastic/go-elasticsearch): Официальный клиент для работы с Elasticsearch, поддерживает все основные функции Elasticsearch.
4) AWS S3:
Для работы с AWS S3 можно использовать официальный SDK от AWS для Go:
- [AWS SDK for Go](https://github.com/aws/aws-sdk-go): Поддерживает работу с S3 и другими сервисами AWS.
5) ClickHouse:
Для работы с ClickHouse в Go доступны следующие библиотеки:
- [ClickHouse Go](https://github.com/ClickHouse/clickhouse-go): Официальный клиент для работы с ClickHouse. Поддерживает все основные функции, включая создание запросов, чтение и запись данных.
6) Kafka:
Для интеграции с Apache Kafka в Go можно использовать следующие библиотеки:
- [Sarama](https://github.com/Shopify/sarama): Одна из самых популярных библиотек для работы с Kafka в Go. Поддерживает как продюсеров (producers), так и потребителей (consumers), включая работу с разделами (partitions) и балансировку нагрузки.

<h2 id="7">7 Алгоритмы</h2>

## Поиск товаров

Поиск — один из основных источников дохода маркетплейсов. Основаня задача поиска строиться следующим образом. По некому запросу нужно выбрать множество товаров и упорядочить его таким образом, чтобы результирующий отранжированный список максимизировал показатель удовлетворенности пользователей.

### Этапы поиска:

### 1. Retrieval:
**Описание:** На этом этапе задача состоит в том, чтобы найти множество товаров, которые потенциально могут быть релевантны запросу пользователя. Для этого используется механизм поиска, основанный на индексации данных, например, с использованием ElasticSearch (ES).

**Подробный процесс:**
1) Каждый товар из таблицы `Product_ElasticSearch` индексируется по важным полям, таким как название товара и его описание. *Индексация* — это процесс создания структуры данных, которая позволяет быстро находить документы (товары), соответствующие поисковому запросу.
2) Пользовательский запрос преобразуется в JSON-объект, который отправляется в ElasticSearch. Запрос может содержать несколько параметров, например, ключевые слова.
3) Поиск по ключевым словам:
- ElasticSearch ищет совпадения как по точным словам, так и по их частям (например, по частям слов в названии и описании товаров). Это позволяет найти товары, в которых встречаются как точные, так и неточные совпадения с запросом.
  - В основе частичного совпадения в ElasticSearch лежит алгоритм анализатора текста, который использует технику токенизации и n-граммы для обработки текста.
  - Токенизация — это процесс разбиения текста на отдельные компоненты (токены), такие как слова. Эти токены индексируются, и поиск может производиться как по полным токенам (словам), так и по их частям.
  - Пример: Если пользователь вводит запрос "футболка", ElasticSearch может искать товары с токенами "футбол", "болка", "форма". Это достигается с помощью индексов n-грамм — последовательностей из нескольких символов, которые помогают находить частичные совпадения.
- ElasticSearch использует механизм векторного поиска (Approximate Nearest Neighbor - ANN), что позволяет находить товары, близкие к запросу по смыслу, а не только по точным совпадениям ключевых слов. Это эффективно для поиска товаров с неточными совпадениями или синонимами. Векторный поиск в ElasticSearch основан на методах поиска ближайших соседей в многомерных пространствах. Алгоритм Approximate Nearest Neighbor (ANN) помогает ускорить процесс поиска, особенно в высокоразмерных векторных пространствах.
**Алгоритм ANN:**
  - Запрос и документы (товары) представляются в виде векторов в многомерном пространстве.
  - Для каждого товара (документа) создается векторное представление на основе его текста (название, описание) с использованием техник, таких как Word2Vec, которые кодируют семантическую информацию.
  - Задача поиска заключается в нахождении ближайших соседей (векторов товаров), которые находятся на минимальном расстоянии от вектора запроса. Для нахождения ближайших товаров (соседей) используется косинусное расстояние или евклидово расстояние. Чем выше значение косинусной близости, тем релевантнее товар.
  - Пример: Если запрос "красная футболка", то ANN алгоритм находит товары, чьи векторы находятся максимально близко к вектору запроса, даже если в названии или описании товара нет точного совпадения слов, но есть схожие по смыслу термины.
4) В результате Retrieval возвращается большое множество товаров, которые хотя бы частично соответствуют запросу пользователя, не учитывая их ранжирование на этом этапе.

### 2. Ranking:
**Описание:** Теперь, когда мы получили большое множество товаров на этапе Retrieval, необходимо их упорядочить по релевантности. Здесь ElasticSearch использует алгоритм BM25, который оценивает, насколько релевантен каждый товар запросу пользователя.

**Подробный процесс:**
1) Okapi BM25: Это алгоритм ранжирования, который использует следующие параметры для оценки релевантности:
  - TF (Term Frequency): Количество раз, которое ключевое слово из запроса встречается в документе (товаре). Чем больше совпадений, тем выше оценка.
  - IDF (Inverse Document Frequency): Вес каждого ключевого слова, учитывающий, насколько редкое или частое это слово в базе данных товаров. Редкие слова имеют больший вес, чем часто встречающиеся.
  - Длина документа: Более длинные тексты (например, длинные описания товаров) могут получить меньше веса, так как вероятность случайного совпадения выше.
2) В результате, товары сортируются в зависимости от их релевантности запросу с учётом всех вышеперечисленных параметров, и формируется список товаров для дальнейшей обработки.

### 3. Re-ranking:
**Описание:** После этапа ранжирования с помощью BM25, когда отобраны несколько тысяч наиболее релевантных товаров, проводится дополнительное реранжирование с использованием методов машинного обучения. На этом этапе, помимо текстовой релевантности, в расчет берутся другие факторы, которые могут влиять на пользовательский опыт.

**Подробный процесс:**
1) Логистическая регрессия — это популярная модель машинного обучения, используемая для бинарной классификации, но в задаче реранжирования она применяется для оценки вероятности того, что конкретный товар удовлетворяет запрос пользователя с учетом различных факторов (текстовая релевантность, пользовательские данные и бизнес-метрики). Цель этой модели — рассчитать вероятность того, что товар будет полезен или интересен пользователю, и на основе этой вероятности пересортировать товары.
Эта модель позволяет учитывать несколько факторов одновременно:
  - Как близки название и описание товара к поисковому запросу пользователя.
  - Данные о кликах, покупках и взаимодействиях пользователей с похожими товарами. Эти данные берутся из таблицы Product_Stats.
2) Модель рассчитывает итоговый скор (числовое значение, которое вычисляется для каждого товара в процессе поиска и ранжирования) для каждого товара, и на этом этапе товары сортируются по этому скору, учитывая как текстовую релевантность, так и исторические данные и предпочтения пользователей.

## Главная страница персонализированных предложений
Главная страница Wildberries отображает персонализированные предложения на основе данных, собранных о пользователе, и взаимодействий с платформой.

Алгоритм персонализации:
1) Сбор данных — информация о действиях пользователя (просмотры, клики, добавления в корзину) хранится в таблицах Shopping_Cart_Item, Product_Stats, Product_Rating.
2) Анализ предпочтений — используется машинное обучение для предсказания товаров, которые могут быть интересны пользователю на основе данных из таблиц Shopping_Cart_Item, Order_Info и Profile.
Градиентный бустинг — это метод, который строит ансамбль решающих деревьев, где каждая новая модель пытается минимизировать ошибки предыдущих. Процесс можно описать так:
* Алгоритм начинает с базовой модели, которая делает простое предсказание для всех данных (например, среднее значение).
* Далее строятся несколько решающих деревьев, которые обучаются исправлять ошибки предыдущей модели. Каждое дерево предсказывает, насколько текущее предсказание модели отклоняется от истинного значения (например, реального интереса пользователя).
* На каждом шаге новая модель добавляется к ансамблю, и итоговый прогноз представляет собой сумму всех предыдущих предсказаний. Каждая новая модель делает предсказание чуть лучше, чем предыдущие, постепенно уменьшая ошибку.
3) Ранжирование товаров — алгоритм учитывает как текстовую близость товаров к интересам пользователя, так и бизнес-логику (например, товары, участвующие в акциях).

## Модерация
Для обеспечения качества представляемых товаров и контента на платформе Wildberries используется двухэтапная система модерации.
- Автоматическая модерация — товары проходят автоматическую проверку на соответствие правилам площадки с помощью анализа данных из таблиц Product и Moderation. На этом этапе используется модель машинного обучения для фильтрации контента, который может нарушать правила (например, некорректные изображения или описание).
- Ручная модерация — сотрудники площадки могут просматривать товары, отмеченные системой, или отклоненные пользователями. Таблица Moderation хранит информацию о статусах модерации, причинах отклонения и времени проверки.

<h2 id="sources">Список источников</h2>

1. https://www.similarweb.com/ru/website/wildberries.ru/#demographics
2. https://oborot.ru/news/kolichestvo-posetitelej-marketplejsov-wildberries-i-ozon-v-mesyac-sravnyalos-kuda-eshhe-hodyat-pokupateli-i209527.html
3. https://dzen.ru/a/ZkT8wKCKkBgtJMT-
4. https://adindex.ru/news/researches/2023/02/28/310879.phtml
5. https://dzen.ru/a/ZkT8wKCKkBgtJMT-
6. https://www.vedomosti.ru/business/articles/2024/05/05/1035562-ozon-i-wildberries
7. https://www.cnews.ru/news/line/2023-06-08_wildberries_itogi_i_kvartala_2023
